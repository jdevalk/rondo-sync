# Milestone v2.1: Improved Nikki Import

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 27-29
**Total Plans:** 3

## Overview

Enhance Nikki contribution sync with CSV data extraction and per-year ACF field storage in Stadion. Enables historical contribution tracking with 4-year retention.

## Phases

### Phase 27: CSV Download & Data Matching ✓

**Goal**: Download CSV from Nikki Rapporten link and match contribution data to members by nikki_id
**Depends on**: Phase 26
**Requirements**: CSV-01, CSV-02, CSV-03, MATCH-01, MATCH-02, MATCH-03
**Success Criteria:**
  1. CSV file downloads automatically after /leden table scrape completes
  2. System extracts hoofdsom (total amount) from CSV for each member with valid nikki_id
  3. Members without nikki_id are processed without errors (gracefully skipped)
  4. CSV data correctly matches to existing /leden records for validation
**Plans:** 1 plan
**Completed:** 2026-02-01

Plans:
- [x] 27-01-PLAN.md — CSV download, parsing, and data merge with hoofdsom field

**Details:**
- Added csv-parse library for robust CSV parsing
- Playwright download handling with waitForEvent pattern
- Map-based data merge by nikki_id lookup
- Graceful degradation when CSV unavailable

### Phase 28: Per-Year SQLite Storage ✓

**Goal**: Store 4 years of historical contribution data per member in SQLite (current + 3 previous)
**Depends on**: Phase 27
**Requirements**: STORE-01, STORE-02, STORE-03
**Success Criteria:**
  1. SQLite schema stores contribution data with year, knvb_id, total, saldo, status columns
  2. Historical data persists across syncs (4 years retained per member)
  3. Current year data updates correctly on each sync (replace, not append)
  4. Query can retrieve multi-year history for any member by knvb_id
**Plans:** 1 plan
**Completed:** 2026-02-01

Plans:
- [x] 28-01-PLAN.md — Remove clearContributions, add pruneOldContributions with 4-year retention

**Details:**
- Upsert-before-prune pattern prevents data loss
- Year-based retention pruning (cutoffYear = currentYear - retentionYears + 1)
- Configurable retention window (default: 4 years)

### Phase 29: Stadion ACF Sync ✓

**Goal**: Sync individual per-year contribution fields to Stadion person ACF
**Depends on**: Phase 28
**Requirements**: SYNC-01, SYNC-02, SYNC-03, SYNC-04
**Success Criteria:**
  1. Each person record in Stadion shows _nikki_{year}_total field with correct value
  2. Each person record in Stadion shows _nikki_{year}_saldo field with correct value
  3. Each person record in Stadion shows _nikki_{year}_status field with correct value
  4. All years (2-3) sync correctly for each member in one sync operation
**Plans:** 1 plan
**Completed:** 2026-02-01

Plans:
- [x] 29-01-PLAN.md — Per-year ACF field sync to Stadion

**Details:**
- buildPerYearAcfFields function generates field payload
- 12 custom fields registered via Stadion API (4 years x 3 fields)
- Fields: _nikki_{year}_total, _nikki_{year}_saldo, _nikki_{year}_status

---

## Milestone Summary

**Key Decisions:**

- Use csv-parse library for CSV parsing (stream-based, handles BOM)
- 4-year retention window (current + 3 previous years)
- Upsert-before-prune pattern prevents data loss during sync
- ACF custom fields require registration via API (dynamic fields not supported)

**Issues Resolved:**

- CSV format differences handled with multiple column name fallbacks
- Graceful degradation when Rapporten link not found
- Historical data now persists across syncs

**Technical Debt Incurred:**

- None

---

*For current project status, see .planning/ROADMAP.md*
