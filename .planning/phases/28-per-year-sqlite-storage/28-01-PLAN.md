---
phase: 28-per-year-sqlite-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/nikki-db.js
  - download-nikki-contributions.js
autonomous: true

must_haves:
  truths:
    - "Historical contribution data persists across syncs (2+ years visible after multiple syncs)"
    - "Current year data updates correctly on each sync (values change when source changes)"
    - "Data older than retention window is automatically pruned"
    - "Query can retrieve multi-year history for any member by knvb_id"
  artifacts:
    - path: "lib/nikki-db.js"
      provides: "pruneOldContributions function with configurable retention window"
      exports: ["pruneOldContributions"]
    - path: "download-nikki-contributions.js"
      provides: "Historical retention instead of clear-all behavior"
      contains: "pruneOldContributions"
  key_links:
    - from: "download-nikki-contributions.js"
      to: "lib/nikki-db.js"
      via: "imports pruneOldContributions"
      pattern: "pruneOldContributions"
    - from: "download-nikki-contributions.js"
      to: "nikki_contributions table"
      via: "retention logic after upsert"
      pattern: "pruneOldContributions\\(db"
---

<objective>
Enable per-year historical data retention in the Nikki contributions database.

Purpose: Currently each sync wipes all existing data before importing. This phase removes the destructive `clearContributions()` call and adds year-based retention pruning, allowing 4 years of historical contribution data (current year + 3 previous) to persist across syncs.

Output: Modified nikki-db.js with pruneOldContributions function, updated download-nikki-contributions.js that preserves historical data while enforcing retention window.

Note: The 4-year retention window (current + 3 previous) is intentional. This was clarified in research/context to mean "current year plus 2-3 previous years", which equals 3-4 years total. 4 years is the intended safe default.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/nikki-db.js
@download-nikki-contributions.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pruneOldContributions function to nikki-db.js</name>
  <files>lib/nikki-db.js</files>
  <action>
Add a new function `pruneOldContributions(db, retentionYears = 4)` to lib/nikki-db.js:

1. Calculate the cutoff year: `currentYear - retentionYears + 1`
   - Example: In 2026 with 4 years retention, cutoff = 2026 - 4 + 1 = 2023
   - Keeps: 2023, 2024, 2025, 2026 (4 years)
   - Deletes: anything before 2023

2. Execute DELETE statement: `DELETE FROM nikki_contributions WHERE year < ?`

3. Return the number of rows deleted (from stmt.run().changes)

4. Export the function in module.exports

CRITICAL: Use `new Date().getFullYear()` to get 4-digit year. NEVER use deprecated `getYear()` which returns year minus 1900.

Example implementation:
```javascript
function pruneOldContributions(db, retentionYears = 4) {
  const currentYear = new Date().getFullYear();
  const cutoffYear = currentYear - retentionYears + 1;
  const stmt = db.prepare('DELETE FROM nikki_contributions WHERE year < ?');
  const info = stmt.run(cutoffYear);
  return info.changes;
}
```
  </action>
  <verify>
Run both checks:
1. Verify function exists in file: `grep -q "function pruneOldContributions" lib/nikki-db.js && echo "Function defined: PASS"`
2. Verify export works: `node -e "const m = require('./lib/nikki-db'); console.log('Export type:', typeof m.pruneOldContributions)"`
Expected: "Function defined: PASS" and "Export type: function"
  </verify>
  <done>
pruneOldContributions function exists in lib/nikki-db.js, is exported, and compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace clearContributions with pruneOldContributions in download script</name>
  <files>download-nikki-contributions.js</files>
  <action>
Modify download-nikki-contributions.js to preserve historical data:

1. Update the import statement at top of file:
   - Remove `clearContributions` from the destructured imports
   - Add `pruneOldContributions` to the imports

2. Remove the `clearContributions(db)` call on line ~510 (inside the `if (contributions.length > 0)` block)

3. Add `pruneOldContributions(db)` call AFTER the `upsertContributions(db, contributions)` call:
   ```javascript
   // Store to database (upsert handles current year updates)
   upsertContributions(db, contributions);

   // Prune data older than retention window (keeps 4 years)
   const pruned = pruneOldContributions(db);
   if (pruned > 0) {
     logger.verbose(`Pruned ${pruned} old contribution records`);
   }

   result.count = contributions.length;
   ```

4. Verify the import line reads:
   ```javascript
   const {
     openDb,
     upsertContributions,
     getContributionCount,
     pruneOldContributions
   } = require('./lib/nikki-db');
   ```

IMPORTANT: The order matters - upsert first (adds/updates current data), then prune (removes old data). This prevents accidentally deleting data that was just inserted.
  </action>
  <verify>
Run: `node -c download-nikki-contributions.js && grep -q "pruneOldContributions" download-nikki-contributions.js && ! grep -q "clearContributions(db)" download-nikki-contributions.js && echo "PASS"`
Expected: "PASS"

Note: We check for `clearContributions(db)` (the function CALL) specifically, not just the word `clearContributions`, because the function definition may still exist in lib/nikki-db.js for backwards compatibility.
  </verify>
  <done>
download-nikki-contributions.js no longer calls clearContributions(db), instead calls pruneOldContributions after upsert. File compiles without errors.
  </done>
</task>

</tasks>

<verification>
Run all verification commands:

```bash
# 1. Syntax check both files
node -c lib/nikki-db.js && echo "nikki-db.js OK"
node -c download-nikki-contributions.js && echo "download-nikki-contributions.js OK"

# 2. Verify pruneOldContributions function exists in file AND is exported
grep -q "function pruneOldContributions" lib/nikki-db.js && echo "pruneOldContributions defined: PASS" || echo "pruneOldContributions not defined: FAIL"
node -e "const m = require('./lib/nikki-db'); console.log('pruneOldContributions:', typeof m.pruneOldContributions)"

# 3. Verify clearContributions(db) call is no longer in download script
! grep -q "clearContributions(db)" download-nikki-contributions.js && echo "clearContributions(db) call removed: PASS" || echo "clearContributions(db) call still present: FAIL"

# 4. Verify pruneOldContributions is called in download script
grep -q "pruneOldContributions(db)" download-nikki-contributions.js && echo "pruneOldContributions called: PASS" || echo "pruneOldContributions not called: FAIL"

# 5. Verify the upsert-then-prune order (upsert should come before prune)
node -e "
const fs = require('fs');
const content = fs.readFileSync('download-nikki-contributions.js', 'utf8');
const upsertPos = content.indexOf('upsertContributions(db');
const prunePos = content.indexOf('pruneOldContributions(db');
if (upsertPos > 0 && prunePos > 0 && upsertPos < prunePos) {
  console.log('Order correct: upsert before prune: PASS');
} else {
  console.log('Order incorrect: FAIL');
}
"
```

All checks must pass.
</verification>

<success_criteria>
1. lib/nikki-db.js contains pruneOldContributions function definition (grep confirms)
2. lib/nikki-db.js exports pruneOldContributions function (node require confirms)
3. download-nikki-contributions.js no longer calls clearContributions(db)
4. download-nikki-contributions.js imports and calls pruneOldContributions after upsert
5. Both files pass syntax check (node -c)
6. Upsert happens before prune (order verified)
</success_criteria>

<output>
After completion, create `.planning/phases/28-per-year-sqlite-storage/28-01-SUMMARY.md`
</output>
