---
phase: 05-stadion-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-client.js
autonomous: true
user_setup:
  - service: stadion
    why: "WordPress REST API authentication"
    env_vars:
      - name: RONDO_URL
        source: "Your Stadion WordPress site URL (e.g., https://stadion.example.com)"
      - name: RONDO_USERNAME
        source: "WordPress username with REST API access"
      - name: RONDO_APP_PASSWORD
        source: "WordPress Admin -> Users -> Your Profile -> Application Passwords -> Add New"
    dashboard_config:
      - task: "Generate application password"
        location: "WordPress Admin -> Users -> Your Profile -> Application Passwords"

must_haves:
  truths:
    - "Client can make authenticated GET request to WordPress REST API"
    - "Client can make authenticated POST request to WordPress REST API"
    - "Invalid credentials return structured error (not crash)"
    - "Network errors return structured error (not crash)"
    - "Missing env vars fail fast with clear message"
  artifacts:
    - path: "lib/stadion-client.js"
      provides: "Stadion API client with authentication and error handling"
      min_lines: 100
      exports: ["stadionRequest", "testConnection"]
  key_links:
    - from: "lib/stadion-client.js"
      to: "process.env.RONDO_*"
      via: "varlock/auto-load and readEnv()"
      pattern: "process\\.env\\.RONDO_"
    - from: "lib/stadion-client.js"
      to: "WordPress REST API"
      via: "https.request with Basic Auth"
      pattern: "Authorization.*Basic"
---

<objective>
Create Stadion API client with WordPress application password authentication and structured error handling.

Purpose: Establish the foundation for Stadion sync - all future Stadion operations will use this client.
Output: `lib/stadion-client.js` that can make authenticated REST API requests and handle errors gracefully.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-stadion-foundation/05-RESEARCH.md
@.planning/phases/05-stadion-foundation/05-CONTEXT.md
@submit-laposta-list.js (reference for patterns)
@lib/logger.js (reference for logger integration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stadion API client with authentication</name>
  <files>lib/stadion-client.js</files>
  <action>
Create `lib/stadion-client.js` following the exact patterns from `submit-laposta-list.js`:

1. **Environment loading** (top of file):
   - `require('varlock/auto-load');`
   - `readEnv()` helper function matching Laposta pattern
   - Load RONDO_URL, RONDO_USERNAME, RONDO_APP_PASSWORD

2. **Core request function** `stadionRequest(endpoint, method, body = null)`:
   - Returns Promise (matching Laposta's `lapostaMemberRequest` pattern)
   - Build Basic Auth header: `Buffer.from(username:password).toString('base64')`
   - Parse RONDO_URL to extract hostname
   - Build path as `/wp-json/${endpoint}` (allow full endpoint path)
   - Set headers: Authorization, Content-Type: application/json
   - Handle response chunks (accumulate with `data += chunk`)
   - Parse JSON response (with try/catch for non-JSON)
   - On success (2xx): resolve with `{ status, body }`
   - On error (4xx/5xx): reject with Error that has `details` property containing parsed response
   - On network error: reject with the error

3. **Credential validation** (called at start of request):
   - Check all three env vars exist
   - Check RONDO_URL starts with 'https://'
   - Throw clear error if missing: "RONDO_URL, RONDO_USERNAME, and RONDO_APP_PASSWORD required in .env"

4. **Timeout handling**:
   - Set 30 second timeout on request
   - Handle ETIMEDOUT gracefully with structured error

Do NOT add logging yet (Task 2 handles that). Focus on core request mechanics.
  </action>
  <verify>
File exists at lib/stadion-client.js with:
- `require('varlock/auto-load')` at top
- `stadionRequest` function exported
- Basic Auth header construction
- Promise-based request handling
- Structured error with `details` property
  </verify>
  <done>
`stadionRequest(endpoint, method, body)` function exists that:
- Makes authenticated HTTPS requests to WordPress REST API
- Returns `{ status, body }` on success
- Returns error with `details` property on failure
- Validates credentials exist before making request
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test connection and logging support</name>
  <files>lib/stadion-client.js</files>
  <action>
Add to the existing `lib/stadion-client.js`:

1. **Logger integration** (matching Laposta pattern):
   - Add optional `options` parameter to `stadionRequest`: `stadionRequest(endpoint, method, body, options = {})`
   - Extract `{ logger, verbose }` from options
   - Create `logVerbose` helper: `logger ? logger.verbose.bind(logger) : (verbose ? console.log : () => {})`
   - Log request details in verbose mode: method, endpoint
   - Log response status in verbose mode

2. **Test connection function** `testConnection(options = {})`:
   - Makes GET request to empty endpoint (WordPress REST API root: `/wp-json/`)
   - Returns `{ success: true, name: response.body.name, url: response.body.url }` on success
   - Returns `{ success: false, error: message, details: error.details }` on failure
   - Never throws - always returns result object
   - Log connection attempt and result via logger

3. **WordPress error parsing** helper `parseWordPressError(errorBody)`:
   - Extract `code`, `message`, `status` from WordPress error format
   - Handle both object errors and string errors
   - Return normalized error object

4. **Module exports**:
   - Export `{ stadionRequest, testConnection }`
  </action>
  <verify>
`node -e "const { testConnection } = require('./lib/stadion-client'); console.log(typeof testConnection)"` outputs "function"
  </verify>
  <done>
`testConnection(options)` function exists that:
- Returns `{ success: true, name, url }` when credentials work
- Returns `{ success: false, error, details }` when credentials fail
- Never crashes regardless of error type
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI entry point for testing</name>
  <files>lib/stadion-client.js</files>
  <action>
Add CLI entry point at bottom of `lib/stadion-client.js` following the module/CLI hybrid pattern:

1. **CLI detection**:
   ```javascript
   if (require.main === module) {
     // CLI code here
   }
   ```

2. **Argument parsing**:
   - Check for `--verbose` flag
   - Check for `--test` flag (run testConnection)

3. **Default behavior** (no args or just --verbose):
   - Run `testConnection({ verbose })`
   - Print result: "Connected to {name}" or "Connection failed: {error}"
   - Exit code 0 on success, 1 on failure

4. **Output format**:
   - Success: `Stadion connection OK: {site name}`
   - Failure: `Stadion connection FAILED: {error message}`
   - If verbose: also print response details

This allows running `node lib/stadion-client.js` to test credentials are working.
  </action>
  <verify>
Run `node lib/stadion-client.js --help 2>&1 || node lib/stadion-client.js 2>&1` shows either help text or attempts connection (may fail if env vars not set, but script runs without syntax error)
  </verify>
  <done>
`node lib/stadion-client.js` can be run standalone to test Stadion connection. Outputs clear success/failure message and exits with appropriate code.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:

1. **File exists and exports correctly:**
   ```bash
   node -e "const m = require('./lib/stadion-client'); console.log(Object.keys(m).sort().join(', '))"
   # Expected: stadionRequest, testConnection
   ```

2. **Syntax valid:**
   ```bash
   node --check lib/stadion-client.js
   # Expected: no output (success)
   ```

3. **CLI runs without env vars (should fail gracefully):**
   ```bash
   RONDO_URL= RONDO_USERNAME= RONDO_APP_PASSWORD= node lib/stadion-client.js 2>&1 | head -1
   # Expected: Error message about missing env vars, not stack trace
   ```

4. **Follows codebase patterns:**
   - Uses `require('varlock/auto-load')` at top
   - Uses `https` module (not axios/fetch)
   - Promise-based async (not callbacks)
   - Structured error responses (not throws in main flow)
</verification>

<success_criteria>
Phase 5 is complete when:
- [ ] `lib/stadion-client.js` exists with 100+ lines
- [ ] `stadionRequest()` makes authenticated WordPress REST API calls
- [ ] `testConnection()` validates credentials work
- [ ] Errors return structured objects (never crash)
- [ ] Missing env vars produce clear error message
- [ ] CLI entry point allows standalone testing
- [ ] Code follows established codebase patterns (varlock, https module, Promise-based)
</success_criteria>

<output>
After completion, create `.planning/phases/05-stadion-foundation/05-01-SUMMARY.md` using the summary template.
</output>
