---
phase: 15-pipeline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sync-all.js
autonomous: true

must_haves:
  truths:
    - "Team sync runs automatically as part of daily sync pipeline"
    - "Work history sync runs automatically after team sync"
    - "Email report shows team sync statistics (created, updated, skipped)"
    - "Email report shows work history statistics (created, ended, skipped)"
    - "Team sync failures do not block other sync operations"
    - "Work history sync failures do not block other sync operations"
  artifacts:
    - path: "sync-all.js"
      provides: "Team and work history sync integration"
      contains: "runTeamSync"
      contains: "runWorkHistorySync"
  key_links:
    - from: "sync-all.js"
      to: "submit-stadion-teams.js"
      via: "require and runSync call"
      pattern: "require.*submit-stadion-teams"
    - from: "sync-all.js"
      to: "submit-stadion-work-history.js"
      via: "require and runSync call"
      pattern: "require.*submit-stadion-work-history"
    - from: "printSummary()"
      to: "stats.teams"
      via: "TEAM SYNC section output"
      pattern: "TEAM SYNC"
    - from: "printSummary()"
      to: "stats.workHistory"
      via: "WORK HISTORY SYNC section output"
      pattern: "WORK HISTORY"
---

<objective>
Integrate team sync and work history sync into the daily automated pipeline with email reporting.

Purpose: Complete v1.5 Team Sync milestone by connecting Phase 13 (team extraction) and Phase 14 (work history) scripts to the sync-all orchestrator.
Output: Updated sync-all.js with team and work history sync steps, producing email reports with team statistics.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pipeline-integration/15-RESEARCH.md

# Key reference files
@sync-all.js (current pipeline orchestrator - follow existing patterns)
@submit-stadion-teams.js (team sync module to integrate)
@submit-stadion-work-history.js (work history sync module to integrate)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add team sync and work history sync steps to pipeline</name>
  <files>sync-all.js</files>
  <action>
Follow the exact non-critical sync pattern used for birthday sync (lines 408-432).

1. Add imports at top of file:
   ```javascript
   const { runSync: runTeamSync } = require('./submit-stadion-teams');
   const { runSync: runWorkHistorySync } = require('./submit-stadion-work-history');
   ```

2. Add stats structures in the stats object initialization (after birthdays, around line 217):
   ```javascript
   teams: {
     total: 0,
     synced: 0,
     created: 0,
     updated: 0,
     skipped: 0,
     errors: []
   },
   workHistory: {
     total: 0,
     synced: 0,
     created: 0,
     ended: 0,
     skipped: 0,
     errors: []
   }
   ```

3. Add Step 4b (Team Sync) AFTER Step 4 (Stadion member sync) and BEFORE Step 5 (Photo Download).
   Use NON-CRITICAL pattern (try-catch wrapper):
   ```javascript
   // Step 4b: Team Sync (NON-CRITICAL)
   logger.verbose('Syncing teams to Stadion...');
   try {
     const teamResult = await runTeamSync({ logger, verbose, force });
     stats.teams.total = teamResult.total;
     stats.teams.synced = teamResult.synced;
     stats.teams.created = teamResult.created;
     stats.teams.updated = teamResult.updated;
     stats.teams.skipped = teamResult.skipped;
     if (teamResult.errors?.length > 0) {
       stats.teams.errors = teamResult.errors.map(e => ({
         team_name: e.team_name,
         message: e.message,
         system: 'team-sync'
       }));
     }
   } catch (err) {
     logger.error(`Team sync failed: ${err.message}`);
     stats.teams.errors.push({
       message: `Team sync failed: ${err.message}`,
       system: 'team-sync'
     });
   }
   ```

4. Add Step 4c (Work History Sync) immediately after team sync:
   ```javascript
   // Step 4c: Work History Sync (NON-CRITICAL)
   logger.verbose('Syncing work history to Stadion...');
   try {
     const workHistoryResult = await runWorkHistorySync({ logger, verbose, force });
     stats.workHistory.total = workHistoryResult.total;
     stats.workHistory.synced = workHistoryResult.synced;
     stats.workHistory.created = workHistoryResult.created;
     stats.workHistory.ended = workHistoryResult.ended;
     stats.workHistory.skipped = workHistoryResult.skipped;
     if (workHistoryResult.errors?.length > 0) {
       stats.workHistory.errors = workHistoryResult.errors.map(e => ({
         knvb_id: e.knvb_id,
         message: e.message,
         system: 'work-history-sync'
       }));
     }
   } catch (err) {
     logger.error(`Work history sync failed: ${err.message}`);
     stats.workHistory.errors.push({
       message: `Work history sync failed: ${err.message}`,
       system: 'work-history-sync'
     });
   }
   ```

Note: Team sync must run BEFORE work history sync because work history references team IDs.
  </action>
  <verify>
Run `node sync-all.js --verbose 2>&1 | head -100` and confirm:
- "Syncing teams to Stadion..." appears in output
- "Syncing work history to Stadion..." appears after team sync
- No fatal errors from the new steps
  </verify>
  <done>
Team sync and work history sync steps execute as non-critical pipeline steps without blocking other sync operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add report sections and update error aggregation</name>
  <files>sync-all.js</files>
  <action>
1. Add TEAM SYNC section to printSummary() AFTER STADION SYNC and BEFORE PHOTO SYNC (around line 86):
   ```javascript
   logger.log('TEAM SYNC');
   logger.log(minorDivider);
   if (stats.teams.total > 0) {
     logger.log(`Teams synced: ${stats.teams.synced}/${stats.teams.total}`);
     if (stats.teams.created > 0) {
       logger.log(`  Created: ${stats.teams.created}`);
     }
     if (stats.teams.updated > 0) {
       logger.log(`  Updated: ${stats.teams.updated}`);
     }
     if (stats.teams.skipped > 0) {
       logger.log(`  Skipped: ${stats.teams.skipped} (unchanged)`);
     }
   } else {
     logger.log('Teams synced: 0 changes');
   }
   logger.log('');
   ```

2. Add WORK HISTORY SYNC section immediately after TEAM SYNC:
   ```javascript
   logger.log('WORK HISTORY SYNC');
   logger.log(minorDivider);
   if (stats.workHistory.total > 0) {
     logger.log(`Members synced: ${stats.workHistory.synced}/${stats.workHistory.total}`);
     if (stats.workHistory.created > 0) {
       logger.log(`  Team assignments added: ${stats.workHistory.created}`);
     }
     if (stats.workHistory.ended > 0) {
       logger.log(`  Team assignments ended: ${stats.workHistory.ended}`);
     }
     if (stats.workHistory.skipped > 0) {
       logger.log(`  Skipped: ${stats.workHistory.skipped} (not yet in Stadion)`);
     }
   } else {
     logger.log('Work history synced: 0 changes');
   }
   logger.log('');
   ```

3. Update allErrors array (around line 130) to include team and work history errors:
   ```javascript
   const allErrors = [
     ...stats.errors,
     ...stats.stadion.errors,
     ...stats.teams.errors,           // ADD
     ...stats.workHistory.errors,     // ADD
     ...stats.photos.download.errors,
     ...stats.photos.upload.errors,
     ...stats.photos.delete.errors,
     ...stats.birthdays.errors
   ];
   ```

4. Update success calculation (around line 447) to include team and work history errors:
   ```javascript
   return {
     success: stats.errors.length === 0 &&
              stats.stadion.errors.length === 0 &&
              stats.teams.errors.length === 0 &&           // ADD
              stats.workHistory.errors.length === 0 &&     // ADD
              stats.photos.download.errors.length === 0 &&
              stats.photos.upload.errors.length === 0 &&
              stats.photos.delete.errors.length === 0 &&
              stats.birthdays.errors.length === 0,
     stats
   };
   ```
  </action>
  <verify>
Run `node sync-all.js --verbose 2>&1 | grep -A 20 "TEAM SYNC"` and confirm:
- TEAM SYNC section appears with stats
- WORK HISTORY SYNC section appears after TEAM SYNC
- Both sections show appropriate counts (synced, created, etc.)

Run `node sync-all.js 2>&1 | tail -50` and verify the summary includes both new sections.
  </verify>
  <done>
Email report includes TEAM SYNC and WORK HISTORY SYNC sections with statistics. Errors from both systems appear in ERRORS section and affect exit code.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run full pipeline: `npm run sync-all-verbose 2>&1 | tee /tmp/sync-test.log`

2. Verify output contains all sections in order:
   - TOTALS
   - PER-LIST BREAKDOWN
   - STADION SYNC
   - TEAM SYNC (new)
   - WORK HISTORY SYNC (new)
   - PHOTO SYNC
   - BIRTHDAY SYNC
   - ERRORS (if any)

3. Verify email format by checking log output structure:
   - ALL CAPS headers for section names
   - Consistent divider lines
   - Key-value pairs for statistics

4. Test failure isolation:
   - If team sync throws, work history and photo sync should still run
   - Exit code should reflect any errors in team or work history sync
</verification>

<success_criteria>
- [x] Team sync runs automatically after member sync, before photo sync
- [x] Work history sync runs automatically after team sync
- [x] TEAM SYNC section appears in summary with: synced/total, created, updated, skipped
- [x] WORK HISTORY SYNC section appears with: synced/total, assignments added, assignments ended, skipped
- [x] Team sync errors appear in ERRORS section with [team-sync] tag
- [x] Work history errors appear in ERRORS section with [work-history-sync] tag
- [x] Team/work history errors affect success calculation and exit code
- [x] Team sync failure does not block photo sync, birthday sync, or Laposta sync
- [x] Requirements TEAM-10 and TEAM-11 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/15-pipeline-integration/15-01-SUMMARY.md`
</output>
