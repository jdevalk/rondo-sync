---
phase: 33-birthday-field-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - steps/prepare-stadion-members.js
  - pipelines/sync-people.js
autonomous: true

must_haves:
  truths:
    - "Running sync-people populates acf.birthdate (Y-m-d) on every person in Stadion that has a DateOfBirth"
    - "The people pipeline no longer calls sync-important-dates.js"
    - "Email report shows birthdate count inside STADION SYNC section, not a separate BIRTHDAY SYNC section"
  artifacts:
    - path: "steps/prepare-stadion-members.js"
      provides: "Birthdate extraction and ACF field population"
      contains: "acf.birthdate"
    - path: "pipelines/sync-people.js"
      provides: "Pipeline without birthday sync step, updated report"
  key_links:
    - from: "steps/prepare-stadion-members.js"
      to: "steps/submit-stadion-sync.js"
      via: "preparePerson returns acf.birthdate in data payload"
      pattern: "birthdate"
---

<objective>
Add birthdate as an ACF field on the person record and remove the separate birthday sync step from the people pipeline.

Purpose: Replace the complex important_date post lifecycle (create/update/delete separate WordPress posts) with a simple ACF field on the person, synced during the existing person sync step.
Output: Modified prepare step that includes birthdate, pipeline without Step 5, updated email report.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-birthday-field-migration/33-RESEARCH.md
@steps/prepare-stadion-members.js
@pipelines/sync-people.js
@steps/sync-important-dates.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add birthdate to person ACF payload</name>
  <files>steps/prepare-stadion-members.js</files>
  <action>
Add an `extractBirthdate` function that validates and returns the full YYYY-MM-DD date string (or null). Place it near the existing `extractBirthYear` function.

```javascript
function extractBirthdate(dateOfBirth) {
  if (!dateOfBirth) return null;
  const trimmed = dateOfBirth.trim();
  if (!trimmed.match(/^\d{4}-\d{2}-\d{2}$/)) return null;
  return trimmed;
}
```

In `preparePerson`, call `extractBirthdate(sportlinkMember.DateOfBirth)` and add the result to the ACF object:
- After the existing `if (birthYear) acf.birth_year = birthYear;` line
- Add: `const birthdate = extractBirthdate(sportlinkMember.DateOfBirth);`
- Add: `if (birthdate) acf.birthdate = birthdate;`

The birthdate variable declaration should be near the existing `birthYear` declaration at the top of `preparePerson`.

This follows the exact same pattern as all other optional ACF fields in this function. No other files need changes -- the existing `submit-stadion-sync.js` already sends whatever ACF fields are in the data payload, so birthdate will be included automatically.
  </action>
  <verify>
Run `node steps/prepare-stadion-members.js --verbose` and confirm the sample prepared member output includes `"birthdate": "YYYY-MM-DD"` in the ACF object. The script should complete without errors.
  </verify>
  <done>
`preparePerson` includes `acf.birthdate` for members with valid DateOfBirth. Members without DateOfBirth or with invalid format get no birthdate field (null excluded from ACF object).
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove birthday sync step and update email report</name>
  <files>pipelines/sync-people.js</files>
  <action>
Three changes to `pipelines/sync-people.js`:

**A. Remove the import** (line 10):
Delete `const { runSync: runBirthdaySync } = require('../steps/sync-important-dates');`

**B. Remove Step 5** (lines 270-293):
Delete the entire "Step 5: Birthday Sync" block that calls `runBirthdaySync`. This includes the try/catch wrapping it.

**C. Update stats and report:**

1. Remove `birthdays` from the `stats` object initialization (lines 144-151). Remove the entire `birthdays: { total: 0, synced: 0, ... }` block.

2. In `printSummary`, remove the "BIRTHDAY SYNC" section (lines 50-56 that log the birthday header and stats).

3. In `printSummary`, remove `...stats.birthdays.errors` from the `allErrors` aggregation (line 94).

4. In the success check at the bottom (line 388), remove `stats.birthdays.errors.length === 0` from the condition.

Do NOT add a "birthdates populated" counter to the STADION SYNC section. The birthdate is now just another ACF field like birth_year or gender -- it flows through the existing person sync hash-based change detection. The existing "Persons synced: X/Y (Z created, W updated)" line already covers it.

After these changes, the pipeline goes directly from Step 4 (Stadion sync) to Step 6 (Photo Download). Renumber comments if they reference step numbers, but the step numbering in code comments is not critical.
  </action>
  <verify>
1. `node -e "require('./pipelines/sync-people.js')"` loads without errors (no missing require).
2. Grep for `runBirthdaySync` in sync-people.js returns no results.
3. Grep for `BIRTHDAY SYNC` in sync-people.js returns no results.
4. Grep for `stats.birthdays` in sync-people.js returns no results.
  </verify>
  <done>
The people pipeline no longer imports, calls, or reports on sync-important-dates.js. Birthday data flows through the existing person sync as an ACF field. Email report has no separate "BIRTHDAY SYNC" section.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./steps/prepare-stadion-members.js')"` -- loads without error
2. `node -e "require('./pipelines/sync-people.js')"` -- loads without error
3. `node steps/prepare-stadion-members.js --verbose` -- shows birthdate in sample output
4. No references to `runBirthdaySync` or `BIRTHDAY SYNC` in sync-people.js
</verification>

<success_criteria>
- prepare-stadion-members.js includes birthdate in ACF payload for members with valid DateOfBirth
- sync-people.js no longer imports or calls sync-important-dates.js
- Email report format has no separate BIRTHDAY SYNC section
- Both files load without errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-birthday-field-migration/33-01-SUMMARY.md`
</output>
