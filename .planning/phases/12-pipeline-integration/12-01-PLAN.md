---
phase: 12-pipeline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sync-all.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Photo download runs as part of npm run sync-all"
    - "Photo upload/delete runs as part of npm run sync-all"
    - "Email report shows photo download count"
    - "Email report shows photo upload count"
    - "Email report shows photo deletion count"
    - "Email report shows photo coverage (X of Y members have photos)"
    - "Photo errors appear in ERRORS section of report"
    - "Exit code is non-zero when photo errors occur"
  artifacts:
    - path: "sync-all.js"
      provides: "Photo sync integration into pipeline"
      contains: "runPhotoDownload"
    - path: "sync-all.js"
      provides: "Photo sync integration into pipeline"
      contains: "runPhotoSync"
    - path: "package.json"
      provides: "Photo download npm script"
      contains: "download-photos"
  key_links:
    - from: "sync-all.js"
      to: "download-photos-from-sportlink.js"
      via: "require runPhotoDownload"
      pattern: "require.*download-photos-from-sportlink"
    - from: "sync-all.js"
      to: "upload-photos-to-stadion.js"
      via: "require runPhotoSync"
      pattern: "require.*upload-photos-to-stadion"
---

<objective>
Integrate photo sync into sync-all.js pipeline with email reporting.

Purpose: Complete v1.4 milestone by connecting photo download and upload/delete steps into the automated daily sync, with statistics reported in the email summary.
Output: Modified sync-all.js with photo steps, extended printSummary() with photo section, npm scripts for photo-only operations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-pipeline-integration/12-CONTEXT.md
@.planning/phases/12-pipeline-integration/12-RESEARCH.md

@sync-all.js (orchestrator to extend)
@download-photos-from-sportlink.js (runPhotoDownload function signature)
@upload-photos-to-stadion.js (runPhotoSync function signature)
@lib/stadion-db.js (openDb for coverage query)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend sync-all.js with photo sync steps</name>
  <files>sync-all.js</files>
  <action>
Extend sync-all.js to include photo sync in the pipeline. Follow the established patterns exactly.

**Imports (lines 3-7):**
Add after existing requires:
```javascript
const { runPhotoDownload } = require('./download-photos-from-sportlink');
const { runPhotoSync } = require('./upload-photos-to-stadion');
const { openDb } = require('./lib/stadion-db');
```

**Stats initialization (lines 111-131):**
Add photos section after stadion:
```javascript
photos: {
  download: {
    total: 0,
    downloaded: 0,
    skipped: 0,
    failed: 0,
    errors: []
  },
  upload: {
    total: 0,
    synced: 0,
    skipped: 0,
    errors: []
  },
  delete: {
    total: 0,
    deleted: 0,
    errors: []
  },
  coverage: {
    members_with_photos: 0,
    total_members: 0
  }
}
```

**Photo download step (after Stadion sync, before timing):**
Add after line 245 (Stadion catch block), before line 247 (timing):
```javascript
// Step 5: Photo Download (NON-CRITICAL)
logger.verbose('Downloading photos from Sportlink...');
try {
  const photoDownloadResult = await runPhotoDownload({ logger, verbose });

  stats.photos.download = {
    total: photoDownloadResult.total,
    downloaded: photoDownloadResult.downloaded,
    skipped: photoDownloadResult.skipped || 0,
    failed: photoDownloadResult.failed,
    errors: (photoDownloadResult.errors || []).map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-download'
    }))
  };
} catch (err) {
  logger.error(`Photo download failed: ${err.message}`);
  stats.photos.download.errors.push({
    message: `Photo download failed: ${err.message}`,
    system: 'photo-download'
  });
}

// Step 6: Photo Upload/Delete (NON-CRITICAL)
logger.verbose('Syncing photos to Stadion...');
try {
  const photoSyncResult = await runPhotoSync({ logger, verbose });

  stats.photos.upload = {
    total: photoSyncResult.upload.total,
    synced: photoSyncResult.upload.synced,
    skipped: photoSyncResult.upload.skipped,
    errors: (photoSyncResult.upload.errors || []).map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-upload'
    }))
  };

  stats.photos.delete = {
    total: photoSyncResult.delete.total,
    deleted: photoSyncResult.delete.deleted,
    errors: (photoSyncResult.delete.errors || []).map(e => ({
      knvb_id: e.knvb_id,
      message: e.message,
      system: 'photo-delete'
    }))
  };
} catch (err) {
  logger.error(`Photo sync failed: ${err.message}`);
  stats.photos.upload.errors.push({
    message: `Photo sync failed: ${err.message}`,
    system: 'photo-upload'
  });
}

// Calculate photo coverage
try {
  const db = openDb();
  const totalMembers = db.prepare('SELECT COUNT(*) as count FROM stadion_members').get().count;
  const membersWithPhotos = db.prepare(
    "SELECT COUNT(*) as count FROM stadion_members WHERE photo_state = 'synced'"
  ).get().count;
  db.close();

  stats.photos.coverage = {
    members_with_photos: membersWithPhotos,
    total_members: totalMembers
  };
} catch (err) {
  logger.verbose(`Could not calculate photo coverage: ${err.message}`);
}
```

**Extend printSummary() (after STADION SYNC section, before ERRORS):**
Insert after line 81 (stadion deleted log), before line 83 (allErrors):
```javascript
logger.log('PHOTO SYNC');
logger.log(minorDivider);
const photoDownloadText = stats.photos.download.total > 0
  ? `${stats.photos.download.downloaded}/${stats.photos.download.total}`
  : '0 changes';
logger.log(`Photos downloaded: ${photoDownloadText}`);
if (stats.photos.download.failed > 0) {
  logger.log(`  Failed: ${stats.photos.download.failed}`);
}

const photoUploadText = stats.photos.upload.total > 0
  ? `${stats.photos.upload.synced}/${stats.photos.upload.total}`
  : '0 changes';
logger.log(`Photos uploaded: ${photoUploadText}`);
if (stats.photos.upload.skipped > 0) {
  logger.log(`  Skipped: ${stats.photos.upload.skipped}`);
}

const photoDeleteText = stats.photos.delete.total > 0
  ? `${stats.photos.delete.deleted}/${stats.photos.delete.total}`
  : '0 changes';
logger.log(`Photos deleted: ${photoDeleteText}`);

logger.log(`Coverage: ${stats.photos.coverage.members_with_photos} of ${stats.photos.coverage.total_members} members have photos`);
logger.log('');
```

**Update allErrors aggregation (line 83):**
Change from:
```javascript
const allErrors = [...stats.errors, ...stats.stadion.errors];
```
To:
```javascript
const allErrors = [
  ...stats.errors,
  ...stats.stadion.errors,
  ...stats.photos.download.errors,
  ...stats.photos.upload.errors,
  ...stats.photos.delete.errors
];
```

**Update success calculation (line 261):**
Change from:
```javascript
success: stats.errors.length === 0 && stats.stadion.errors.length === 0,
```
To:
```javascript
success: stats.errors.length === 0 &&
         stats.stadion.errors.length === 0 &&
         stats.photos.download.errors.length === 0 &&
         stats.photos.upload.errors.length === 0 &&
         stats.photos.delete.errors.length === 0,
```
  </action>
  <verify>
Run `node sync-all.js --verbose` (will fail if structure is wrong).
The output should show PHOTO SYNC section after STADION SYNC.
  </verify>
  <done>
sync-all.js includes photo download and upload/delete steps.
printSummary() shows PHOTO SYNC section with download/upload/delete/coverage stats.
Photo errors included in ERRORS section with [photo-download], [photo-upload], [photo-delete] tags.
Exit code reflects photo errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add npm scripts for photo-only operations</name>
  <files>package.json</files>
  <action>
Add npm scripts for standalone photo operations.

In package.json scripts section, add:
```json
"download-photos": "node download-photos-from-sportlink.js",
"download-photos-verbose": "node download-photos-from-sportlink.js --verbose",
```

Keep existing sync-photos scripts (already present for upload-photos-to-stadion.js).

This allows operators to run:
- `npm run download-photos` - Download photos from Sportlink only
- `npm run sync-photos` - Upload/delete photos to Stadion only (already exists)
- `npm run sync-all` - Full pipeline including photos
  </action>
  <verify>
Run `npm run download-photos -- --help` (should show usage or run without error).
Run `npm run` and verify download-photos scripts appear in list.
  </verify>
  <done>
package.json has download-photos and download-photos-verbose scripts.
Operators can run photo download independently from full sync.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run sync-all-verbose` and verify:
   - PHOTO SYNC section appears in output after STADION SYNC
   - Photo download stats shown (X/Y or "0 changes")
   - Photo upload stats shown (X/Y or "0 changes")
   - Photo delete stats shown (X/Y or "0 changes")
   - Coverage stat shown (X of Y members have photos)

2. Check log file includes photo statistics

3. Run `npm run download-photos` and verify it executes standalone

4. Run `npm run sync-photos` and verify it executes standalone (existing)
</verification>

<success_criteria>
- [ ] PHOTO-11: Photo sync runs as part of sync-all pipeline
- [ ] PHOTO-12: Email report includes photo sync statistics
- [ ] Photo download step runs after Stadion sync
- [ ] Photo upload/delete step runs after download
- [ ] Coverage calculated from stadion_members table
- [ ] Photo errors included in ERRORS section
- [ ] Exit code non-zero when photo errors occur
- [ ] npm run download-photos works standalone
</success_criteria>

<output>
After completion, create `.planning/phases/12-pipeline-integration/12-01-SUMMARY.md`
</output>
