---
phase: 08-pipeline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sync-all.js
  - scripts/send-email.js
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Running npm run sync-all syncs to both Laposta and Stadion"
    - "Email report shows Laposta section and Stadion section separately"
    - "Stadion section shows combined persons count (members + parents)"
    - "Errors from both systems appear in consolidated ERRORS section"
    - "Stadion failure does not fail overall sync if Laposta succeeded"
  artifacts:
    - path: "sync-all.js"
      provides: "Orchestration of both Laposta and Stadion syncs"
      contains: "runSync.*stadion"
    - path: "scripts/send-email.js"
      provides: "HTML email formatting for both systems"
      contains: "STADION SYNC"
  key_links:
    - from: "sync-all.js"
      to: "submit-stadion-sync.js"
      via: "runSync import and call"
      pattern: "require.*submit-stadion-sync"
    - from: "sync-all.js"
      to: "scripts/send-email.js"
      via: "printSummary output format"
      pattern: "STADION SYNC"
---

<objective>
Integrate Stadion sync into the sync-all pipeline and extend email reports to include both systems.

Purpose: Complete v1.3 milestone - running `npm run sync-all` syncs to both Laposta and Stadion with unified reporting.
Output: Updated sync-all.js with dual-system orchestration, extended email formatter, updated documentation.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pipeline-integration/08-CONTEXT.md
@.planning/phases/08-pipeline-integration/08-RESEARCH.md

# Source files to modify
@sync-all.js
@scripts/send-email.js
@submit-stadion-sync.js
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Stadion sync into sync-all.js</name>
  <files>sync-all.js</files>
  <action>
Update sync-all.js to orchestrate both Laposta and Stadion syncs:

1. Add import: `const { runSync: runStadionSync } = require('./submit-stadion-sync');`

2. Update parseArgs to add `--dry-run` flag (for future use, passed to both syncs):
```javascript
function parseArgs(argv) {
  return {
    verbose: argv.includes('--verbose'),
    force: argv.includes('--force'),
    dryRun: argv.includes('--dry-run')
  };
}
```

3. Extend stats object to include stadion section:
```javascript
const stats = {
  // ... existing fields ...
  stadion: {
    total: 0,
    synced: 0,
    created: 0,
    updated: 0,
    skipped: 0,
    deleted: 0,
    errors: []
  }
};
```

4. After Laposta submit (Step 3), add Stadion sync (Step 4):
```javascript
// Step 4: Sync to Stadion
logger.verbose('Syncing to Stadion...');
try {
  const stadionResult = await runStadionSync({ logger, verbose, force });

  // Members stats
  stats.stadion.total = stadionResult.total;
  stats.stadion.synced = stadionResult.synced;
  stats.stadion.created = stadionResult.created;
  stats.stadion.updated = stadionResult.updated;
  stats.stadion.skipped = stadionResult.skipped;
  stats.stadion.deleted = stadionResult.deleted;

  // Parents stats (add to totals for combined persons count)
  if (stadionResult.parents) {
    stats.stadion.total += stadionResult.parents.total;
    stats.stadion.synced += stadionResult.parents.synced;
    stats.stadion.created += stadionResult.parents.created;
    stats.stadion.updated += stadionResult.parents.updated;
    stats.stadion.skipped += stadionResult.parents.skipped;
    stats.stadion.deleted += stadionResult.parents.deleted;

    // Collect parent errors
    if (stadionResult.parents.errors?.length > 0) {
      stats.stadion.errors.push(...stadionResult.parents.errors.map(e => ({
        email: e.email,
        message: e.message,
        system: 'stadion'
      })));
    }
  }

  // Collect member errors
  if (stadionResult.errors?.length > 0) {
    stats.stadion.errors.push(...stadionResult.errors.map(e => ({
      knvb_id: e.knvb_id,
      email: e.email,
      message: e.message,
      system: 'stadion'
    })));
  }
} catch (err) {
  // Stadion failure is non-critical - log error but continue
  logger.error(`Stadion sync failed: ${err.message}`);
  stats.stadion.errors.push({
    message: `Stadion sync failed: ${err.message}`,
    system: 'stadion'
  });
}
```

5. Update printSummary to include Stadion section (AFTER Laposta, BEFORE errors):
```javascript
// After PER-LIST BREAKDOWN section, add:

logger.log('STADION SYNC');
logger.log(minorDivider);
logger.log(`Persons synced: ${stats.stadion.synced}/${stats.stadion.total} (${stats.stadion.created} created, ${stats.stadion.updated} updated)`);
logger.log(`Skipped: ${stats.stadion.skipped} (unchanged)`);
if (stats.stadion.deleted > 0) {
  logger.log(`Deleted: ${stats.stadion.deleted}`);
}
logger.log('');

// Modify ERRORS section to include all errors:
const allErrors = [...stats.errors, ...stats.stadion.errors];
if (allErrors.length > 0) {
  logger.log(`ERRORS (${allErrors.length})`);
  logger.log(minorDivider);
  allErrors.forEach(error => {
    const identifier = error.knvb_id || error.email || 'system';
    const system = error.system ? ` [${error.system}]` : '';
    logger.log(`- ${identifier}${system}: ${error.message}`);
  });
  logger.log('');
}
```

6. Update success determination to include Stadion errors:
```javascript
return {
  success: stats.errors.length === 0 && stats.stadion.errors.length === 0,
  stats
};
```

7. Pass dryRun through options in CLI entry point (even though not yet implemented in sync functions).
  </action>
  <verify>
Run `node sync-all.js --verbose 2>&1 | head -100` to verify:
- Stadion sync is called after Laposta
- Summary includes STADION SYNC section
- No crashes when Stadion env vars are missing (graceful error handling)
  </verify>
  <done>
sync-all.js orchestrates both Laposta and Stadion syncs, with combined error handling and separate summary sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend email HTML formatter</name>
  <files>scripts/send-email.js</files>
  <action>
Update formatAsHtml() to properly render the new Stadion section:

1. The existing parser already handles section headers (all caps) and key-value lines, so "STADION SYNC" section should render correctly with existing logic.

2. However, ensure the section header detection handles "STADION SYNC" explicitly for better styling. Update the section header regex comment to note it handles both systems:
```javascript
// Section headers (all caps) - handles TOTALS, PER-LIST BREAKDOWN, STADION SYNC, ERRORS, etc.
if (/^[A-Z][A-Z\s()-]+$/.test(trimmed) && trimmed.length > 3) {
```

3. Add visual distinction for system sections. After the existing h2 styles, add:
```css
h2 {
  font-size: 14px;
  color: #666;
  margin-top: 24px;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
/* First h2 after intro needs less top margin */
h1 + * + h2, h1 + h2 {
  margin-top: 16px;
}
```

4. Verify error formatting handles system tag: the existing list item formatting (`- identifier [system]: message`) will render correctly as:
```html
<li>12345 [stadion]: API timeout</li>
```

Test the complete flow by checking the HTML output structure matches the plain text structure.
  </action>
  <verify>
Create a test file with sample output and run through the formatter:
```bash
node -e "
const { formatAsHtml } = require('./scripts/send-email.js');
// Note: formatAsHtml is not exported, so verify by reading the file structure
" 2>&1
```

Alternatively, run a sync and check the log file structure, then verify send-email.js can process it:
```bash
cat logs/$(ls -t logs/ | head -1) | head -50
```
  </verify>
  <done>
Email HTML formatter correctly renders Stadion section with appropriate styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update documentation</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md to reflect the complete sync pipeline:

1. Update the Architecture section's Data Flow diagram:
```
### Data Flow

```
Sportlink Club (browser) → CSV → SQLite (state) → Laposta API
                                      ↓
                              Hash-based diff
                                      ↓
                           Only changed members sync
                                      ↓
                              Stadion WordPress API
```
```

2. Update Quick Reference to show sync-all now does both:
```bash
npm run sync-all          # Full sync pipeline (Sportlink → Laposta + Stadion)
```

3. Add note that Stadion reads from SQLite database (not CSV):
```
### Sync Pipeline

1. **download-data-from-sportlink.js** - Browser automation downloads member CSV
2. **prepare-laposta-members.js** - Transforms Sportlink fields for Laposta
3. **submit-laposta-list.js** - Syncs to Laposta via API (hash-based change detection)
4. **submit-stadion-sync.js** - Syncs to Stadion WordPress (reads from SQLite, not CSV)
5. **sync-all.js** - Orchestrates full pipeline, produces email-ready summary
```

4. Add STADION_ environment variables to the Environment Variables section:
```bash
# Stadion WordPress
STADION_URL=              # WordPress site URL (https://...)
STADION_USERNAME=         # WordPress username
STADION_APP_PASSWORD=     # Application password (from WordPress profile)
STADION_PERSON_TYPE=      # Custom post type (default: person)
```
  </action>
  <verify>
Read CLAUDE.md and verify all sync systems are documented:
```bash
grep -E "(Stadion|Laposta|sync-all)" CLAUDE.md
```
  </verify>
  <done>
CLAUDE.md accurately reflects the complete dual-system sync pipeline.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full sync and verify both systems:
```bash
npm run sync-all-verbose 2>&1 | grep -E "(LAPOSTA|STADION|SYNC|synced|created|updated)"
```

2. Check log file includes both sections:
```bash
cat logs/$(ls -t logs/ | head -1) | grep -E "(LAPOSTA|STADION SYNC|Persons synced)"
```

3. Verify npm scripts work:
```bash
npm run sync-all --help 2>&1 || echo "No help, but should not error"
```
</verification>

<success_criteria>
- `npm run sync-all` runs Laposta sync followed by Stadion sync
- Console summary shows separate LAPOSTA and STADION SYNC sections
- Email report (via cron) will include both sections
- Stadion errors do not crash the pipeline - they are collected and reported
- CLAUDE.md documents the complete pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/08-pipeline-integration/08-01-SUMMARY.md`
</output>
