---
phase: 24-free-fields-financial-toggle
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - reverse-sync.js
  - scripts/sync.sh
  - scripts/install-cron.sh
autonomous: true

must_haves:
  truths:
    - "scripts/sync.sh reverse runs reverse sync with flock locking and email delivery"
    - "Cron schedule runs reverse sync every 15 minutes"
    - "Email reports include reverse sync statistics when changes occur"
    - "Reverse sync failures do not block forward sync operations"
  artifacts:
    - path: "reverse-sync.js"
      provides: "Unified CLI entry point for all reverse sync fields"
      exports: ["runAllFieldsReverseSync"]
    - path: "scripts/sync.sh"
      provides: "Support for 'reverse' sync type"
      contains: "reverse)"
    - path: "scripts/install-cron.sh"
      provides: "15-minute cron schedule for reverse sync"
      contains: "*/15"
  key_links:
    - from: "reverse-sync.js"
      to: "lib/reverse-sync-sportlink.js"
      via: "runReverseSyncMultiPage import"
      pattern: "runReverseSyncMultiPage"
    - from: "scripts/sync.sh"
      to: "reverse-sync.js"
      via: "case statement for reverse type"
      pattern: "reverse-sync\\.js"
---

<objective>
Create unified reverse sync CLI entry point and integrate into cron infrastructure with 15-minute schedule.

Purpose: Enable automated reverse sync execution via scripts/sync.sh reverse with email reporting and proper scheduling.

Output: reverse-sync.js CLI, updated sync.sh with reverse support, updated install-cron.sh with 15-minute schedule.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-free-fields-financial-toggle/24-01-SUMMARY.md

# Key source files
@reverse-sync-contact-fields.js
@scripts/sync.sh
@scripts/install-cron.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified reverse-sync.js CLI entry point</name>
  <files>reverse-sync.js</files>
  <action>
Create a new file `reverse-sync.js` that serves as the unified entry point for all reverse sync operations (all 7 fields).

Model after `reverse-sync-contact-fields.js` but use `runReverseSyncMultiPage` instead:

```javascript
require('varlock/auto-load');

const { requireProductionServer } = require('./lib/server-check');
const { createSyncLogger } = require('./lib/logger');
const { runReverseSyncMultiPage } = require('./lib/reverse-sync-sportlink');

/**
 * Run full reverse sync for all fields (Stadion -> Sportlink)
 * Syncs contact fields (/general), free fields (/other), and financial toggle (/financial)
 * @param {Object} options
 * @param {boolean} [options.verbose=false] - Verbose mode
 * @param {Object} [options.logger] - External logger
 * @returns {Promise<{success: boolean, synced: number, failed: number, results: Array}>}
 */
async function runAllFieldsReverseSync(options = {}) {
  const { verbose = false, logger: providedLogger } = options;
  const logger = providedLogger || createSyncLogger({ verbose, prefix: 'reverse' });

  logger.log('Starting reverse sync (Stadion -> Sportlink) for all fields...');
  logger.log('Fields: email, email2, mobile, phone, datum-vog, freescout-id, financiele-blokkade');

  try {
    const result = await runReverseSyncMultiPage({ verbose, logger });

    if (result.synced === 0 && result.failed === 0) {
      logger.log('No changes to sync');
    } else {
      logger.log(`Reverse sync complete: ${result.synced} members synced, ${result.failed} failed`);
    }

    return result;
  } catch (err) {
    logger.error(`Reverse sync failed: ${err.message}`);
    return { success: false, synced: 0, failed: 0, error: err.message };
  }
}

module.exports = { runAllFieldsReverseSync };

// CLI entry point
if (require.main === module) {
  // Prevent accidental local runs - database state safety
  requireProductionServer({
    allowLocal: true,  // Allow with warning for testing
    scriptName: 'reverse-sync.js'
  });

  const verbose = process.argv.includes('--verbose');

  runAllFieldsReverseSync({ verbose })
    .then(result => {
      if (!result.success) process.exitCode = 1;
    })
    .catch(err => {
      console.error('Error:', err.message);
      process.exitCode = 1;
    });
}
```

This replaces the need to use reverse-sync-contact-fields.js separately - the new script handles all fields.
  </action>
  <verify>
Run: `node -e "const m = require('./reverse-sync'); console.log('export:', typeof m.runAllFieldsReverseSync)"`
Should output: export: function
  </verify>
  <done>Unified reverse-sync.js CLI entry point created</done>
</task>

<task type="auto">
  <name>Task 2: Update scripts/sync.sh to support reverse sync type</name>
  <files>scripts/sync.sh</files>
  <action>
Update scripts/sync.sh to add support for "reverse" as a sync type.

1. **Update the case validation** (around line 35):
Change:
```bash
case "$SYNC_TYPE" in
    people|photos|teams|functions|nikki|all)
```
To:
```bash
case "$SYNC_TYPE" in
    people|photos|teams|functions|nikki|reverse|all)
```

2. **Update usage message** (around line 39):
Change:
```bash
echo "Usage: $0 {people|photos|teams|functions|nikki|all}" >&2
```
To:
```bash
echo "Usage: $0 {people|photos|teams|functions|nikki|reverse|all}" >&2
```

3. **Add case for reverse** in the script selection (after nikki case, around line 90):
```bash
    reverse)
        SYNC_SCRIPT="reverse-sync.js"
        ;;
```

4. **Update the header comment** at the top of the file:
Add to usage section:
```bash
#   sync.sh reverse  # Every 15 min: reverse sync (Stadion -> Sportlink)
```

Add to crontab example:
```bash
#   */15 * * * * /path/to/sync.sh reverse          # every 15 minutes
```
  </action>
  <verify>
Run: `grep -E "reverse\)" /Users/joostdevalk/Code/rondo/rondo-sync/scripts/sync.sh`
Should output lines showing "reverse)" in case statements
  </verify>
  <done>scripts/sync.sh supports "reverse" sync type</done>
</task>

<task type="auto">
  <name>Task 3: Update scripts/install-cron.sh with reverse sync schedule</name>
  <files>scripts/install-cron.sh</files>
  <action>
Update scripts/install-cron.sh to add the 15-minute reverse sync cron job.

Find the section where cron jobs are defined (look for the existing crontab generation) and add a new entry for reverse sync.

The reverse sync should run every 15 minutes:
```bash
*/15 * * * * cd "$PROJECT_DIR" && scripts/sync.sh reverse >> logs/cron/sync-reverse-\$(date +\%Y\%m\%d-\%H\%M).log 2>&1
```

Notes:
- Use the same pattern as existing cron entries
- The schedule `*/15 * * * *` means "every 15 minutes"
- Add a comment explaining the schedule: `# Reverse sync: every 15 minutes`
- Make sure flock is handled by sync.sh (it already is via the LOCKFILE mechanism)

Also update the echo/display messages that show the user what cron entries will be created to include reverse sync.
  </action>
  <verify>
Run: `grep -E "\*/15.*reverse" /Users/joostdevalk/Code/rondo/rondo-sync/scripts/install-cron.sh`
Should output the reverse sync cron entry
  </verify>
  <done>install-cron.sh includes 15-minute reverse sync schedule</done>
</task>

</tasks>

<verification>
1. CLI entry point works:
   ```bash
   node -e "const m = require('./reverse-sync'); console.log('export:', typeof m.runAllFieldsReverseSync)"
   ```
   Expected: export: function

2. sync.sh recognizes reverse:
   ```bash
   bash -n scripts/sync.sh && grep "reverse)" scripts/sync.sh | head -2
   ```
   Expected: No syntax errors, shows reverse case

3. install-cron.sh has 15-minute schedule:
   ```bash
   grep "*/15" scripts/install-cron.sh
   ```
   Expected: Shows cron entry with */15
</verification>

<success_criteria>
- [ ] reverse-sync.js exists and exports runAllFieldsReverseSync
- [ ] reverse-sync.js uses runReverseSyncMultiPage from lib/reverse-sync-sportlink.js
- [ ] scripts/sync.sh accepts "reverse" as valid sync type
- [ ] scripts/sync.sh runs reverse-sync.js when given "reverse" argument
- [ ] scripts/install-cron.sh creates cron entry running every 15 minutes
- [ ] Reverse sync uses same flock locking pattern as other sync types
</success_criteria>

<output>
After completion, create `.planning/phases/24-free-fields-financial-toggle/24-02-SUMMARY.md`
</output>
