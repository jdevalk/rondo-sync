---
phase: 24-free-fields-financial-toggle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/reverse-sync-sportlink.js
  - lib/stadion-db.js
autonomous: true

must_haves:
  truths:
    - "System navigates to Sportlink /other page and updates datum-vog field"
    - "System navigates to Sportlink /financial page and updates financiele-blokkade checkbox"
    - "Multi-page navigation maintains session state across sequential page visits"
    - "Fail-fast skips entire member if any page fails after retries"
    - "Session timeout triggers re-authentication and continues with next member"
  artifacts:
    - path: "lib/reverse-sync-sportlink.js"
      provides: "Multi-page sync orchestration with session timeout detection"
      exports: ["loginToSportlink", "runReverseSyncMultiPage", "groupChangesByMemberAndPage"]
    - path: "lib/stadion-db.js"
      provides: "Query for all unsynced changes (not just contact fields)"
      exports: ["getUnsyncedChanges"]
  key_links:
    - from: "lib/reverse-sync-sportlink.js"
      to: "lib/stadion-db.js"
      via: "getUnsyncedChanges query"
      pattern: "getUnsyncedChanges\\(db\\)"
    - from: "lib/reverse-sync-sportlink.js"
      to: "Playwright page.goto"
      via: "multi-page navigation"
      pattern: "page\\.goto.*/(general|other|financial)"
---

<objective>
Extend reverse sync module to handle multi-page navigation across Sportlink /general, /other, and /financial pages.

Purpose: Enable datum-vog, freescout-id, and financiele-blokkade fields to sync from Stadion to Sportlink, completing bidirectional sync for all 7 tracked fields.

Output: Updated lib/reverse-sync-sportlink.js with multi-page sync capability, session timeout detection, and checkbox handling for boolean fields.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-free-fields-financial-toggle/24-RESEARCH.md
@.planning/phases/23-contact-fields-reverse-sync/23-01-SUMMARY.md

# Key source files
@lib/reverse-sync-sportlink.js
@lib/stadion-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-field change query to stadion-db.js</name>
  <files>lib/stadion-db.js</files>
  <action>
Add a new function `getUnsyncedChanges(db)` that queries ALL unsynced changes (not just contact fields).

The existing `getUnsyncedContactChanges` only queries email, email2, mobile, phone. The new function should:
- Query all tracked fields: email, email2, mobile, phone, datum-vog, freescout-id, financiele-blokkade
- Return same structure as getUnsyncedContactChanges
- Filter where synced_at IS NULL
- Order by knvb_id, detected_at

Add the export to the module.exports at the end of the file.

Note: The field names in stadion_change_detections match the ACF field names: 'datum-vog', 'freescout-id', 'financiele-blokkade' (with hyphens).
  </action>
  <verify>
Run: `node -e "const db = require('./lib/stadion-db'); console.log(typeof db.getUnsyncedChanges)"`
Should output: function
  </verify>
  <done>getUnsyncedChanges function exists and returns array of all unsynced field changes</done>
</task>

<task type="auto">
  <name>Task 2: Extend reverse-sync-sportlink.js with multi-page navigation</name>
  <files>lib/reverse-sync-sportlink.js</files>
  <action>
Extend lib/reverse-sync-sportlink.js with multi-page sync capabilities:

1. **Update SPORTLINK_FIELD_MAP** to include page context and field types:
```javascript
const SPORTLINK_FIELD_MAP = {
  // /general page (existing - keep placeholders until verified)
  'email': { page: 'general', selector: 'input[name="Email"]', type: 'text' },
  'email2': { page: 'general', selector: 'input[name="Email2"]', type: 'text' },
  'mobile': { page: 'general', selector: 'input[name="Mobile"]', type: 'text' },
  'phone': { page: 'general', selector: 'input[name="Phone"]', type: 'text' },

  // /other page (Phase 24 - free fields)
  'freescout-id': { page: 'other', selector: 'input[name="Remarks3"]', type: 'text' },
  'datum-vog': { page: 'other', selector: 'input[name="Remarks8"]', type: 'text' },

  // /financial page (Phase 24 - financial block)
  'financiele-blokkade': { page: 'financial', selector: 'input[name="HasFinancialTransferBlockOwnClub"]', type: 'checkbox' }
};
```

2. **Add groupChangesByMemberAndPage function:**
Groups changes by member and by page (general/other/financial). Returns a Map where:
- Key: knvb_id
- Value: { general: [...changes], other: [...changes], financial: [...changes] }

3. **Add session timeout detection:**
Create `navigateWithTimeoutCheck(page, url, credentials, options)` that:
- Calls page.goto(url)
- Checks if page.url() contains '/auth/realms/' (login redirect)
- If redirected, calls loginToSportlink() then navigates again
- Throws if re-auth also fails

4. **Add fillFieldByType function:**
Handles text fields vs checkbox fields:
- For checkboxes (financiele-blokkade): use page.check() / page.uncheck()
- For text fields: use page.fill()
- Verify after filling: isChecked() for checkbox, inputValue() for text

5. **Add syncSinglePage function:**
Syncs all field changes for one page type:
- Navigate with timeout check
- Enter edit mode (if needed)
- Fill all fields for that page using fillFieldByType
- Save form
- Verify all fields saved correctly

6. **Add syncMemberMultiPage function:**
Processes a member across all needed pages:
- Determine which pages have changes (skip pages with no changes)
- Visit pages in order: general -> other -> financial
- If any page fails, throw immediately (fail-fast)
- Return list of synced pages on success

7. **Add runReverseSyncMultiPage function:**
Main orchestration function (parallel to existing runReverseSync):
- Get unsynced changes using getUnsyncedChanges (not getUnsyncedContactChanges)
- Group by member and page
- Login once
- For each member: syncMemberMultiPage with retry
- On success: markChangesSynced and updateSportlinkTimestamps for ALL fields
- On failure: skip member, don't update any timestamps (fail-fast)
- Add 1-2s delay between members
- Return stats: { success, synced, failed, results }

8. **Update imports:**
- Import getUnsyncedChanges from stadion-db.js (in addition to existing imports)

9. **Export new functions:**
- Add runReverseSyncMultiPage, groupChangesByMemberAndPage to module.exports

Keep the existing runReverseSync function for backwards compatibility - Phase 23 integration still uses it.
  </action>
  <verify>
Run: `node -e "const rs = require('./lib/reverse-sync-sportlink'); console.log('runReverseSyncMultiPage:', typeof rs.runReverseSyncMultiPage); console.log('groupChangesByMemberAndPage:', typeof rs.groupChangesByMemberAndPage);"`
Should output:
runReverseSyncMultiPage: function
groupChangesByMemberAndPage: function
  </verify>
  <done>Multi-page reverse sync module complete with session timeout detection, checkbox handling, and fail-fast logic</done>
</task>

</tasks>

<verification>
1. Database query function exists:
   ```bash
   node -e "const db = require('./lib/stadion-db'); console.log('getUnsyncedChanges:', typeof db.getUnsyncedChanges)"
   ```
   Expected: getUnsyncedChanges: function

2. Multi-page sync functions exist:
   ```bash
   node -e "const rs = require('./lib/reverse-sync-sportlink'); console.log(Object.keys(rs).filter(k => typeof rs[k] === 'function'))"
   ```
   Expected: Array includes loginToSportlink, runReverseSync, runReverseSyncMultiPage, groupChangesByMemberAndPage

3. SPORTLINK_FIELD_MAP includes all pages:
   ```bash
   node -e "const fs = require('fs'); const content = fs.readFileSync('./lib/reverse-sync-sportlink.js', 'utf8'); console.log('general:', content.includes(\"page: 'general'\")); console.log('other:', content.includes(\"page: 'other'\")); console.log('financial:', content.includes(\"page: 'financial'\"));"
   ```
   Expected: All true
</verification>

<success_criteria>
- [ ] getUnsyncedChanges function queries all 7 tracked fields
- [ ] SPORTLINK_FIELD_MAP includes page context for all fields
- [ ] groupChangesByMemberAndPage correctly partitions changes by knvb_id and page
- [ ] fillFieldByType handles checkbox vs text field types
- [ ] navigateWithTimeoutCheck detects login redirect and re-authenticates
- [ ] syncMemberMultiPage implements fail-fast on any page failure
- [ ] runReverseSyncMultiPage orchestrates multi-page sync with proper stats
- [ ] Existing runReverseSync function still works (backwards compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/24-free-fields-financial-toggle/24-01-SUMMARY.md`
</output>
