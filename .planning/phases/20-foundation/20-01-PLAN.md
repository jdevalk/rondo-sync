---
phase: 20-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-db.js
  - lib/sync-origin.js
autonomous: true

must_haves:
  truths:
    - "Per-field timestamps track when each syncable field was last modified in each system"
    - "Origin tracking distinguishes user edits from sync-initiated changes"
    - "Existing data is preserved during migration (NULL timestamps for untracked history)"
  artifacts:
    - path: "lib/stadion-db.js"
      provides: "Schema migration adding 15 new columns to stadion_members"
      contains: "email_stadion_modified"
    - path: "lib/sync-origin.js"
      provides: "Origin constants and timestamp utilities"
      exports: ["SYNC_ORIGIN", "createTimestamp", "compareTimestamps"]
  key_links:
    - from: "lib/stadion-db.js"
      to: "initDb function"
      via: "PRAGMA table_info checks"
      pattern: "ALTER TABLE stadion_members ADD COLUMN.*_modified"
    - from: "lib/sync-origin.js"
      to: "future sync scripts"
      via: "module exports"
      pattern: "SYNC_ORIGIN"
---

<objective>
Add per-field bidirectional timestamp tracking and origin attribution to the stadion_members table.

Purpose: Enable conflict detection and loop prevention for bidirectional sync. Without knowing when each field was last modified in each system, and by whom (user vs sync), the system cannot safely push changes from Stadion back to Sportlink.

Output: Modified schema with 15 new columns (14 timestamps + 1 origin) and a utility module for timestamp/origin operations.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-foundation/20-CONTEXT.md
@.planning/phases/20-foundation/20-RESEARCH.md
@lib/stadion-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bidirectional timestamp columns to stadion_members</name>
  <files>lib/stadion-db.js</files>
  <action>
Add 15 new columns to the stadion_members table using the existing incremental migration pattern (PRAGMA table_info checks).

**Columns to add (14 timestamp columns):**
For each of these 7 fields, add two timestamp columns:
- email: `email_stadion_modified TEXT`, `email_sportlink_modified TEXT`
- email2: `email2_stadion_modified TEXT`, `email2_sportlink_modified TEXT`
- mobile: `mobile_stadion_modified TEXT`, `mobile_sportlink_modified TEXT`
- phone: `phone_stadion_modified TEXT`, `phone_sportlink_modified TEXT`
- datum_vog: `datum_vog_stadion_modified TEXT`, `datum_vog_sportlink_modified TEXT`
- freescout_id: `freescout_id_stadion_modified TEXT`, `freescout_id_sportlink_modified TEXT`
- financiele_blokkade: `financiele_blokkade_stadion_modified TEXT`, `financiele_blokkade_sportlink_modified TEXT`

**Origin column (1 column):**
- `sync_origin TEXT` - tracks last edit source (user_edit, sync_sportlink_to_stadion, sync_stadion_to_sportlink)

**Implementation:**
1. After the existing `memberColumns` PRAGMA check (around line 233), add checks for each new column
2. Follow the exact pattern used for photo_state columns (lines 239-254)
3. Do NOT set DEFAULT values - leave as NULL to indicate "not yet tracked"
4. Do NOT backfill existing rows - NULL means "modified before tracking started"

**Pattern to follow:**
```javascript
if (!memberColumns.some(col => col.name === 'email_stadion_modified')) {
  db.exec('ALTER TABLE stadion_members ADD COLUMN email_stadion_modified TEXT');
}
```
  </action>
  <verify>
Run: `node -e "const {openDb} = require('./lib/stadion-db'); const db = openDb(); const cols = db.prepare('PRAGMA table_info(stadion_members)').all(); console.log(cols.map(c => c.name).filter(n => n.includes('modified') || n === 'sync_origin').join('\\n'));"`

Expected: Should list all 15 new columns (14 timestamp columns + sync_origin).
  </verify>
  <done>
stadion_members table has 14 per-field timestamp columns and 1 sync_origin column. Existing data preserved (all new columns are NULL for existing rows).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sync-origin utility module</name>
  <files>lib/sync-origin.js</files>
  <action>
Create a new utility module `lib/sync-origin.js` that provides:

**1. SYNC_ORIGIN constants:**
```javascript
const SYNC_ORIGIN = {
  USER_EDIT: 'user_edit',                      // Manual edit in Stadion WordPress
  SYNC_FORWARD: 'sync_sportlink_to_stadion',   // Forward sync from Sportlink
  SYNC_REVERSE: 'sync_stadion_to_sportlink'    // Reverse sync to Sportlink
};
```

**2. TRACKED_FIELDS constant:**
Array of field names that have bidirectional timestamp tracking:
```javascript
const TRACKED_FIELDS = [
  'email', 'email2', 'mobile', 'phone',
  'datum_vog', 'freescout_id', 'financiele_blokkade'
];
```

**3. createTimestamp() function:**
Returns current time in ISO 8601 UTC format (consistent with existing codebase pattern):
```javascript
function createTimestamp() {
  return new Date().toISOString();
}
```

**4. compareTimestamps(ts1, ts2, toleranceMs = 5000) function:**
Compares two ISO 8601 timestamps with clock drift tolerance:
- Returns 1 if ts1 is newer (by more than tolerance)
- Returns -1 if ts2 is newer (by more than tolerance)
- Returns 0 if within tolerance (too close to call)
- Handles NULL timestamps: NULL is treated as infinitely old (epoch)

**5. getTimestampColumnNames(field) function:**
Returns the column names for a field's timestamps:
```javascript
function getTimestampColumnNames(field) {
  return {
    stadion: `${field}_stadion_modified`,
    sportlink: `${field}_sportlink_modified`
  };
}
```

**6. Export all:**
```javascript
module.exports = {
  SYNC_ORIGIN,
  TRACKED_FIELDS,
  createTimestamp,
  compareTimestamps,
  getTimestampColumnNames
};
```

Add JSDoc comments for all functions.
  </action>
  <verify>
Run: `node -e "const so = require('./lib/sync-origin'); console.log('SYNC_ORIGIN:', so.SYNC_ORIGIN); console.log('TRACKED_FIELDS:', so.TRACKED_FIELDS); console.log('createTimestamp:', so.createTimestamp()); console.log('compare null vs now:', so.compareTimestamps(null, so.createTimestamp())); console.log('compare equal:', so.compareTimestamps('2026-01-29T10:00:00.000Z', '2026-01-29T10:00:00.000Z'));"`

Expected: Should print SYNC_ORIGIN object with 3 values, TRACKED_FIELDS array with 7 fields, current timestamp, -1 (null is older), 0 (equal).
  </verify>
  <done>
lib/sync-origin.js exports SYNC_ORIGIN constants, TRACKED_FIELDS array, createTimestamp(), compareTimestamps() with 5-second tolerance, and getTimestampColumnNames().
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify migration on production database copy</name>
  <files>lib/stadion-db.js</files>
  <action>
Test that the migration works correctly with existing data by:

1. Connect to production server and copy the current database:
   ```bash
   scp root@46.202.155.16:/home/sportlink/rondo-sync.sqlite /tmp/stadion-sync-backup.sqlite
   ```

2. Run the migration on the copy locally:
   ```bash
   DB_PATH=/tmp/stadion-sync-backup.sqlite node -e "const {openDb} = require('./lib/stadion-db'); openDb('/tmp/stadion-sync-backup.sqlite');"
   ```

3. Verify the migration succeeded:
   - Count rows before and after (should be identical)
   - Check that new columns exist
   - Check that existing data (knvb_id, stadion_id, etc.) is preserved
   - Check that new columns are NULL (not populated with default values)

If local execution is blocked by the server check, run the test directly on the server after pushing the code.

**Important:** Do NOT modify the production database directly. This task only tests with a copy.
  </action>
  <verify>
Run on copy: `node -e "const db = require('better-sqlite3')('/tmp/stadion-sync-backup.sqlite'); const count = db.prepare('SELECT COUNT(*) as c FROM stadion_members').get(); const cols = db.prepare('PRAGMA table_info(stadion_members)').all(); const hasOrigin = cols.some(c => c.name === 'sync_origin'); const hasEmailTs = cols.some(c => c.name === 'email_stadion_modified'); const sample = db.prepare('SELECT knvb_id, stadion_id, email_stadion_modified, sync_origin FROM stadion_members LIMIT 1').get(); console.log('rows:', count.c, 'hasOrigin:', hasOrigin, 'hasEmailTs:', hasEmailTs, 'sample:', sample);"`

Expected: Row count matches production, hasOrigin=true, hasEmailTs=true, sample shows existing data preserved with NULL in new columns.
  </verify>
  <done>
Migration tested on production database copy. Row count unchanged, all new columns added, existing data preserved, new columns are NULL as expected.
  </done>
</task>

</tasks>

<verification>
**Schema verification:**
```bash
node -e "const {openDb} = require('./lib/stadion-db'); const db = openDb(); const cols = db.prepare('PRAGMA table_info(stadion_members)').all(); const newCols = cols.filter(c => c.name.includes('_modified') || c.name === 'sync_origin'); console.log('New columns:', newCols.length, 'expected: 15'); newCols.forEach(c => console.log(' -', c.name));"
```

**Utility module verification:**
```bash
node -e "const {SYNC_ORIGIN, TRACKED_FIELDS, createTimestamp, compareTimestamps} = require('./lib/sync-origin'); console.log('Origins:', Object.keys(SYNC_ORIGIN).length === 3 ? 'OK' : 'FAIL'); console.log('Fields:', TRACKED_FIELDS.length === 7 ? 'OK' : 'FAIL'); console.log('Timestamp:', createTimestamp().endsWith('Z') ? 'OK (UTC)' : 'FAIL'); console.log('Compare:', compareTimestamps(null, createTimestamp()) === -1 ? 'OK' : 'FAIL');"
```
</verification>

<success_criteria>
1. stadion_members table has 14 new timestamp columns (2 per tracked field)
2. stadion_members table has sync_origin column
3. All new columns default to NULL (no data backfilled)
4. Existing member data is completely preserved
5. lib/sync-origin.js exports SYNC_ORIGIN, TRACKED_FIELDS, createTimestamp(), compareTimestamps(), getTimestampColumnNames()
6. compareTimestamps() handles NULL and implements 5-second tolerance
7. Migration tested on production database copy without data loss
</success_criteria>

<output>
After completion, create `.planning/phases/20-foundation/20-01-SUMMARY.md`
</output>
