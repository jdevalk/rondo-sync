---
phase: 13-team-extraction-and-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stadion-db.js
  - prepare-stadion-teams.js
  - submit-stadion-teams.js
autonomous: true

must_haves:
  truths:
    - "System extracts team name from UnionTeams field when present"
    - "System falls back to ClubTeams field when UnionTeams is empty"
    - "System creates teams in Stadion via POST /wp/v2/teams"
    - "SQLite database tracks team name to Stadion team ID mappings"
  artifacts:
    - path: "lib/stadion-db.js"
      provides: "stadion_teams table and functions"
      contains: "CREATE TABLE IF NOT EXISTS stadion_teams"
    - path: "prepare-stadion-teams.js"
      provides: "Team extraction from Sportlink data"
      exports: ["runPrepare"]
    - path: "submit-stadion-teams.js"
      provides: "Team sync to Stadion"
      exports: ["runSync"]
  key_links:
    - from: "submit-stadion-teams.js"
      to: "lib/stadion-db.js"
      via: "upsertTeams, getTeamsNeedingSync"
      pattern: "require.*stadion-db"
    - from: "submit-stadion-teams.js"
      to: "lib/stadion-client.js"
      via: "stadionRequest"
      pattern: "stadionRequest.*wp/v2/teams"
---

<objective>
Create team extraction and sync infrastructure for Sportlink teams to Stadion

Purpose: Phase 13 establishes the foundation for team sync - extracting unique team names from Sportlink data and creating corresponding team entities in Stadion WordPress. This enables Phase 14 to link members to their teams via work_history entries.

Output:
- stadion_teams table in SQLite for tracking team name -> Stadion ID mappings
- prepare-stadion-teams.js script to extract unique teams from Sportlink
- submit-stadion-teams.js script to create/sync teams to Stadion via REST API
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-team-extraction-and-management/13-RESEARCH.md

# Existing infrastructure to follow patterns from
@lib/stadion-db.js
@lib/stadion-client.js
@prepare-stadion-members.js
@submit-stadion-sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add team table and tracking functions to stadion-db.js</name>
  <files>lib/stadion-db.js</files>
  <action>
Add team tracking infrastructure to lib/stadion-db.js following the existing member/parent pattern:

1. **Add table schema to initDb function:**
```sql
CREATE TABLE IF NOT EXISTS stadion_teams (
  id INTEGER PRIMARY KEY,
  team_name TEXT NOT NULL UNIQUE COLLATE NOCASE,
  stadion_id INTEGER,
  source_hash TEXT NOT NULL,
  last_seen_at TEXT NOT NULL,
  last_synced_at TEXT,
  last_synced_hash TEXT,
  created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_stadion_teams_hash
  ON stadion_teams (source_hash, last_synced_hash);
```

Note: COLLATE NOCASE ensures case-insensitive uniqueness ("Jongens 11-1" == "jongens 11-1")

2. **Add computeTeamHash function:**
```javascript
function computeTeamHash(teamName) {
  const payload = stableStringify({ team_name: teamName });
  return crypto.createHash('sha256').update(payload).digest('hex');
}
```

3. **Add upsertTeams function** (follow upsertMembers pattern):
- Takes array of team name strings
- Uses ON CONFLICT(team_name) DO UPDATE for upsert
- Updates last_seen_at on each run

4. **Add getTeamsNeedingSync function** (follow getMembersNeedingSync pattern):
- Returns teams where last_synced_hash IS NULL OR last_synced_hash != source_hash
- Returns: { team_name, source_hash, stadion_id }

5. **Add updateTeamSyncState function** (follow updateSyncState pattern):
- Updates last_synced_at, last_synced_hash, stadion_id after successful sync

6. **Add getAllTeams function:**
- Returns all teams with their stadion_id (for Phase 14 mapping)
- Returns: { team_name, stadion_id }

7. **Export all new functions** in module.exports

The pattern matches existing member/parent tracking exactly - same hash computation, same sync state tracking.
  </action>
  <verify>
Run Node.js REPL to verify:
```javascript
const { openDb } = require('./lib/stadion-db');
const db = openDb();
// Check table exists
db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='stadion_teams'").get();
// Should return: { name: 'stadion_teams' }
db.close();
```
  </verify>
  <done>
- stadion_teams table created in SQLite database
- computeTeamHash, upsertTeams, getTeamsNeedingSync, updateTeamSyncState, getAllTeams exported
- Existing tests/functionality unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Create team extraction and sync scripts</name>
  <files>prepare-stadion-teams.js, submit-stadion-teams.js</files>
  <action>
Create two scripts following the existing prepare-*/submit-* pattern:

**prepare-stadion-teams.js:**

1. Follow prepare-stadion-members.js structure (Module/CLI hybrid)

2. Add extractTeamName function:
```javascript
function extractTeamName(member) {
  // Priority: UnionTeams first, ClubTeams fallback
  const unionTeam = (member.UnionTeams || '').trim();
  if (unionTeam) return unionTeam;

  const clubTeam = (member.ClubTeams || '').trim();
  return clubTeam || null;
}
```

3. Add runPrepare function:
- Load Sportlink data from laposta-db (same as prepare-stadion-members)
- Extract team names using extractTeamName for each member
- Use Set to deduplicate team names
- Filter out null/empty values
- Sort alphabetically for consistent processing
- Return { success: boolean, teams: string[], skipped: number }

4. Add CLI entry point (verbose mode support)

**submit-stadion-teams.js:**

1. Follow submit-stadion-sync.js structure (Module/CLI hybrid)

2. Add syncTeam function:
```javascript
async function syncTeam(team, db, options) {
  const { team_name, source_hash, stadion_id } = team;

  if (stadion_id) {
    // Team exists - check if changed
    if (team.source_hash === team.last_synced_hash) {
      return { action: 'skipped', id: stadion_id };
    }
    // Update (unlikely - team names don't change)
    const response = await stadionRequest(
      `wp/v2/teams/${stadion_id}`,
      'PUT',
      { title: team_name, status: 'publish' },
      options
    );
    updateTeamSyncState(db, team_name, source_hash, stadion_id);
    return { action: 'updated', id: stadion_id };
  } else {
    // Create new team
    const response = await stadionRequest(
      'wp/v2/teams',
      'POST',
      { title: team_name, status: 'publish' },
      options
    );
    const newId = response.body.id;
    updateTeamSyncState(db, team_name, source_hash, newId);
    return { action: 'created', id: newId };
  }
}
```

3. Add runSync function:
- Call runPrepare to get team names
- Call upsertTeams to update tracking database
- Call getTeamsNeedingSync to find teams needing sync
- Sync each team and track results (created/updated/skipped/errors)
- Return { success, total, synced, created, updated, skipped, errors }

4. Add CLI entry point (verbose, force mode support)

**Important:** Use `wp/v2/teams` as the endpoint. If this returns 404, the WordPress custom post type may need REST configuration (not our concern - Stadion must configure it).
  </action>
  <verify>
```bash
# Test prepare-stadion-teams.js
node prepare-stadion-teams.js --verbose
# Should output: "Extracted X unique teams from Sportlink data"

# Test submit-stadion-teams.js (dry check - will fail if Stadion not configured)
node submit-stadion-teams.js --verbose 2>&1 | head -20
# Should show attempting to sync teams (may error on API if teams CPT not configured)
```
  </verify>
  <done>
- prepare-stadion-teams.js extracts unique team names from Sportlink data
- submit-stadion-teams.js syncs teams to Stadion via REST API
- Both scripts work as module (export runPrepare/runSync) and CLI
- Team extraction prioritizes UnionTeams, falls back to ClubTeams
  </done>
</task>

</tasks>

<verification>
1. Database schema correct:
```bash
node -e "const {openDb}=require('./lib/stadion-db');const db=openDb();console.log(db.prepare(\"PRAGMA table_info(stadion_teams)\").all());db.close()"
```

2. Team extraction works:
```bash
node prepare-stadion-teams.js --verbose
```

3. All exports present:
```bash
node -e "const db=require('./lib/stadion-db');console.log('upsertTeams:',typeof db.upsertTeams);console.log('getTeamsNeedingSync:',typeof db.getTeamsNeedingSync);console.log('updateTeamSyncState:',typeof db.updateTeamSyncState);console.log('getAllTeams:',typeof db.getAllTeams)"
```

4. Submit script runs (may error on API):
```bash
node submit-stadion-teams.js --verbose 2>&1 || echo "API error expected if teams CPT not configured"
```
</verification>

<success_criteria>
- [ ] stadion_teams table exists in SQLite with UNIQUE COLLATE NOCASE on team_name
- [ ] lib/stadion-db.js exports: upsertTeams, getTeamsNeedingSync, updateTeamSyncState, getAllTeams
- [ ] prepare-stadion-teams.js extracts unique teams (UnionTeams priority, ClubTeams fallback)
- [ ] submit-stadion-teams.js syncs teams to Stadion via REST API
- [ ] Both scripts work as modules and CLI
- [ ] Existing functionality unchanged (member sync, parent sync, photo sync still work)
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-extraction-and-management/13-01-SUMMARY.md`
</output>
