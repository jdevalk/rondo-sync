---
phase: 30-download-discipline-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/discipline-db.js
  - download-discipline-cases.js
autonomous: true

must_haves:
  truths:
    - "Running download script captures discipline case data from Sportlink"
    - "Cases are stored in SQLite database with all required fields"
    - "Re-running download updates existing cases (upsert pattern)"
  artifacts:
    - path: "lib/discipline-db.js"
      provides: "SQLite database operations for discipline cases"
      exports: ["openDb", "upsertCases", "getCaseCount"]
    - path: "download-discipline-cases.js"
      provides: "Playwright automation to download discipline cases"
      exports: ["runDownload"]
    - path: "discipline-sync.sqlite"
      provides: "SQLite database with discipline_cases table"
      contains: "discipline_cases"
  key_links:
    - from: "download-discipline-cases.js"
      to: "lib/discipline-db.js"
      via: "require('./lib/discipline-db')"
      pattern: "require.*discipline-db"
    - from: "download-discipline-cases.js"
      to: "Sportlink API"
      via: "page.waitForResponse()"
      pattern: "waitForResponse.*DisciplineClubCasesPlayer|discipline"
---

<objective>
Download discipline case data from Sportlink and store in SQLite database.

Purpose: Enable discipline case sync by capturing source data from Sportlink's Competition Affairs section via browser automation. This is the data foundation for Phase 31 (Stadion sync) and Phase 32 (pipeline integration).

Output: Two new files - `lib/discipline-db.js` (database module) and `download-discipline-cases.js` (download script) - plus `discipline-sync.sqlite` database created at runtime.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/30-download-discipline-cases/30-RESEARCH.md
@lib/nikki-db.js
@download-data-from-sportlink.js
@lib/logger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discipline database module</name>
  <files>lib/discipline-db.js</files>
  <action>
Create `lib/discipline-db.js` following the exact pattern from `lib/nikki-db.js`:

1. **Database path:** `discipline-sync.sqlite` in project root (same pattern as nikki-sync.sqlite)

2. **Schema:** Create `discipline_cases` table with columns:
   - `id INTEGER PRIMARY KEY` (auto-increment)
   - `dossier_id TEXT NOT NULL UNIQUE` (API field: DossierId - primary key for deduplication)
   - `public_person_id TEXT` (API field: PublicPersonId - links to person)
   - `match_date TEXT` (API field: MatchDate)
   - `match_description TEXT` (API field: MatchDescription)
   - `team_name TEXT` (API field: TeamName)
   - `charge_codes TEXT` (API field: ChargeCodes - store as JSON string if array)
   - `charge_description TEXT` (API field: ChargeDescription)
   - `sanction_description TEXT` (API field: SanctionDescription)
   - `processing_date TEXT` (API field: ProcessingDate)
   - `administrative_fee REAL` (API field: AdministrativeFee - nullable)
   - `is_charged INTEGER` (API field: IsCharged - boolean as 0/1)
   - `source_hash TEXT NOT NULL` (computed hash for change detection)
   - `last_seen_at TEXT NOT NULL` (ISO timestamp)
   - `created_at TEXT NOT NULL` (ISO timestamp)

3. **Indexes:**
   - `idx_discipline_cases_person ON discipline_cases (public_person_id)`
   - `idx_discipline_cases_date ON discipline_cases (match_date)`

4. **Functions to implement:**
   - `stableStringify(value)` - deterministic JSON serialization (copy from nikki-db.js)
   - `computeCaseHash(caseData)` - SHA-256 hash of case fields for change detection
   - `openDb(dbPath)` - open database and initialize schema
   - `initDb(db)` - CREATE TABLE IF NOT EXISTS with indexes
   - `upsertCases(db, cases)` - bulk upsert with ON CONFLICT DO UPDATE pattern
   - `getAllCases(db)` - return all cases ordered by match_date DESC
   - `getCasesByPersonId(db, publicPersonId)` - filter by person
   - `getCaseCount(db)` - return count of cases

5. **Upsert pattern:** Use `ON CONFLICT(dossier_id) DO UPDATE SET` to update all fields except `created_at` and `dossier_id`. Update `last_seen_at` on every sync.

6. **Handle nulls gracefully:** Use nullish coalescing for optional fields (e.g., `caseData.AdministrativeFee ?? null`)
  </action>
  <verify>
Step 1 - Module exports correct functions:
```bash
node -e "const db = require('./lib/discipline-db'); console.log(Object.keys(db))"
```
Expected: Array containing openDb, upsertCases, getAllCases, getCaseCount

Step 2 - Database operations work correctly:
```bash
node -e "
const { openDb, upsertCases, getCaseCount, getAllCases } = require('./lib/discipline-db');
const testDb = openDb('./test-discipline.sqlite');
try {
  // Test upsert with mock case
  const testCase = {
    DossierId: 'TEST-001',
    PublicPersonId: 'PERSON-001',
    MatchDate: '2024-01-15',
    MatchDescription: 'Test Match',
    TeamName: 'Test Team',
    ChargeCodes: ['A1'],
    ChargeDescription: 'Test charge',
    SanctionDescription: 'Test sanction',
    ProcessingDate: '2024-01-20',
    AdministrativeFee: 25.00,
    IsCharged: true
  };
  upsertCases(testDb, [testCase]);
  const count = getCaseCount(testDb);
  const cases = getAllCases(testDb);
  console.log('Count:', count, 'First case dossier_id:', cases[0]?.dossier_id);
  if (count === 1 && cases[0]?.dossier_id === 'TEST-001') {
    console.log('DATABASE OPERATIONS OK');
  } else {
    console.log('DATABASE OPERATIONS FAILED');
    process.exit(1);
  }
} finally {
  testDb.close();
  require('fs').unlinkSync('./test-discipline.sqlite');
}
"
```
Expected: Outputs "DATABASE OPERATIONS OK"
  </verify>
  <done>
lib/discipline-db.js exports openDb, initDb, upsertCases, getAllCases, getCasesByPersonId, getCaseCount functions following established SQLite patterns, and database operations (create table, upsert, query) execute without SQL errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create discipline download script</name>
  <files>download-discipline-cases.js</files>
  <action>
Create `download-discipline-cases.js` following the exact pattern from `download-data-from-sportlink.js`:

1. **Imports:**
   ```javascript
   require('varlock/auto-load');
   const otplib = require('otplib');
   const { chromium } = require('playwright');
   const { openDb, upsertCases, getCaseCount } = require('./lib/discipline-db');
   const { createSyncLogger } = require('./lib/logger');
   ```

2. **Main function signature:**
   ```javascript
   async function runDownload(options = {}) {
     const { logger, verbose = false } = options;
     // ... implementation
     return { success: boolean, caseCount: number, error?: string };
   }
   ```

3. **Login flow:** Copy exact login sequence from download-data-from-sportlink.js (lines 54-96):
   - Launch chromium headless
   - Navigate to https://club.sportlink.com/
   - Fill username/password, click login
   - Wait for OTP field, generate OTP, submit
   - Wait for dashboard selector (#panelHeaderTasks)

4. **Navigate to discipline cases:**
   ```javascript
   await page.goto('https://club.sportlink.com/competition-affairs/discipline-cases', { waitUntil: 'domcontentloaded' });
   await page.waitForLoadState('networkidle');
   ```

5. **Set up response capture BEFORE clicking tab:**
   ```javascript
   // CRITICAL: Set up listener BEFORE clicking tab
   const responsePromise = page.waitForResponse(
     resp => resp.url().includes('DisciplineClubCasesPlayer') && resp.request().method() === 'POST',
     { timeout: 60000 }
   );
   ```

   Note: The exact API endpoint URL pattern is unknown. Use partial match on 'DisciplineClubCasesPlayer' or 'discipline'. If this fails, enable DEBUG_LOG=true to observe actual endpoint and adjust pattern.

6. **Click "Individuele tuchtzaken" tab:**
   ```javascript
   await page.click('button:has-text("Individuele tuchtzaken")');
   // Or try: await page.click('[data-tab="individual"]');
   // Or try: await page.getByRole('tab', { name: /individuele/i }).click();
   ```

   Note: Exact selector unknown. Try text-based selector first. If it fails, use Playwright inspector to identify correct selector.

7. **Wait for and parse response:**
   ```javascript
   const response = await responsePromise;
   if (!response.ok()) {
     // Handle error
   }
   const jsonData = await response.json();
   const cases = jsonData.Cases || jsonData.Results || jsonData || [];
   ```

   Note: Response structure unknown. Check for common patterns (Cases, Results, Items) or use entire response if it's an array.

8. **Store in database:**
   ```javascript
   const db = openDb();
   try {
     upsertCases(db, cases);
     const caseCount = getCaseCount(db);
     logger.log(`Downloaded ${cases.length} discipline cases`);
     return { success: true, caseCount };
   } finally {
     db.close();
   }
   ```

9. **Module/CLI hybrid pattern:**
   ```javascript
   module.exports = { runDownload };

   if (require.main === module) {
     const verbose = process.argv.includes('--verbose');
     const { createSyncLogger } = require('./lib/logger');
     const logger = createSyncLogger({ verbose, prefix: 'discipline' });
     runDownload({ logger, verbose })
       .then(result => {
         if (!result.success) process.exitCode = 1;
       })
       .catch(err => {
         console.error('Error:', err.message);
         process.exitCode = 1;
       });
   }
   ```

10. **Debug mode:** Support DEBUG_LOG=true environment variable to log all requests/responses (helpful for discovering actual API endpoint).

**IMPORTANT:** The exact tab selector and API endpoint URL are uncertain from research. The script should work with best-guess selectors. If execution fails, adjust based on debug output. The verification step will confirm functionality.
  </action>
  <verify>
Test 1 - Module loads: `node -e "const d = require('./download-discipline-cases'); console.log(typeof d.runDownload)"`
Expected: outputs "function"

Test 2 - Full execution (on server only):
```bash
ssh root@46.202.155.16
cd /home/sportlink
git pull
DEBUG_LOG=true node download-discipline-cases.js --verbose
```
Expected: Script logs navigation steps, captures API response, outputs "Downloaded N discipline cases"
  </verify>
  <done>
download-discipline-cases.js exports runDownload function that:
- Logs into Sportlink with OTP
- Navigates to /competition-affairs/discipline-cases
- Clicks "Individuele tuchtzaken" tab
- Captures DisciplineClubCasesPlayer API response
- Stores cases in discipline-sync.sqlite via upsert
- Returns { success: true, caseCount: N }
  </done>
</task>

</tasks>

<verification>
1. **Database module loads:** `node -e "require('./lib/discipline-db')"`
2. **Download script loads:** `node -e "require('./download-discipline-cases')"`
3. **Full integration test (server only):**
   ```bash
   ssh root@46.202.155.16
   cd /home/sportlink
   git pull
   node download-discipline-cases.js --verbose
   ```
   Expected output includes "Downloaded N discipline cases"
4. **Database populated:**
   ```bash
   sqlite3 discipline-sync.sqlite "SELECT COUNT(*) FROM discipline_cases"
   ```
   Expected: Returns number > 0 (assuming there are discipline cases in Sportlink)
5. **Idempotent re-run:**
   ```bash
   node download-discipline-cases.js --verbose
   sqlite3 discipline-sync.sqlite "SELECT COUNT(*) FROM discipline_cases"
   ```
   Expected: Same count as before (upsert doesn't create duplicates)
</verification>

<success_criteria>
- lib/discipline-db.js exists with openDb, upsertCases, getAllCases, getCaseCount exports
- download-discipline-cases.js exists with runDownload export
- Running download script navigates to discipline cases page and clicks tab
- API response is captured and parsed
- Cases are stored in discipline-sync.sqlite with all fields
- Re-running script updates existing cases (no duplicates)
- Script follows Module/CLI hybrid pattern for pipeline integration
</success_criteria>

<output>
After completion, create `.planning/phases/30-download-discipline-cases/30-01-SUMMARY.md`
</output>
