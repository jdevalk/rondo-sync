# Plan 29-01: Per-Year ACF Field Sync

```yaml
wave: 1
depends_on: []
files_modified:
  - sync-nikki-to-stadion.js
autonomous: true

must_haves:
  truths:
    - "Person records in Stadion show _nikki_{year}_total field with numeric value"
    - "Person records in Stadion show _nikki_{year}_saldo field with numeric value"
    - "Person records in Stadion show _nikki_{year}_status field with text value"
    - "All available years (2-4) sync for each member in single PUT operation"
  artifacts:
    - path: "sync-nikki-to-stadion.js"
      provides: "Per-year ACF field builder and integration"
      exports: ["buildPerYearAcfFields"]
  key_links:
    - from: "sync-nikki-to-stadion.js"
      to: "Stadion REST API"
      via: "PUT wp/v2/people/{id} with per-year ACF fields"
      pattern: "_nikki_.*_(total|saldo|status)"
```

## Goal

Extend `sync-nikki-to-stadion.js` to write per-year contribution fields (`_nikki_{year}_total`, `_nikki_{year}_saldo`, `_nikki_{year}_status`) to Stadion person ACF records alongside the existing HTML summary field.

## Context

The existing sync script already:
- Fetches person data (GET) to obtain required `first_name`/`last_name` fields
- Updates the `nikki-contributie-status` WYSIWYG field via PUT
- Uses 500ms delays between member updates to avoid server overload
- Implements retry logic with exponential backoff for 5xx errors

Per phase context, this sync:
- Always overwrites (no change detection for per-year fields)
- Leaves fields null/unset for years without data
- Syncs all available years (up to 4) in one PUT per member

## Tasks

<task id="1">
<title>Add per-year field builder and integrate into PUT payload</title>
<type>code</type>
<file>sync-nikki-to-stadion.js</file>
<action>
Add a function `buildPerYearAcfFields(contributions)` and integrate it into the PUT request.

**Step 1: Add the function** after `generateContributionHtml` (around line 39):

```javascript
function buildPerYearAcfFields(contributions) {
  const fields = {};
  for (const c of contributions) {
    fields[`_nikki_${c.year}_total`] = c.hoofdsom ?? null;
    fields[`_nikki_${c.year}_saldo`] = c.saldo ?? null;
    fields[`_nikki_${c.year}_status`] = c.status || null;
  }
  return fields;
}
```

Input: Array of contributions `[{ year, nikki_id, saldo, hoofdsom, status }]`
Output: Object like `{ '_nikki_2025_total': 150.00, '_nikki_2025_saldo': 50.00, '_nikki_2025_status': 'Debet' }`

**Step 2: Modify the PUT request** (around lines 193-204) to include per-year fields:

Before the PUT call, add:
```javascript
const perYearFields = buildPerYearAcfFields(contributions);
```

Then spread into the ACF object:
```javascript
await stadionRequestWithRetry(
  `wp/v2/people/${stadionId}`,
  'PUT',
  {
    acf: {
      first_name: existingFirstName,
      last_name: existingLastName,
      'nikki-contributie-status': html,
      ...perYearFields
    }
  },
  { verbose: false }
);
```
</action>
<verify>node -c sync-nikki-to-stadion.js && grep -A 8 "buildPerYearAcfFields" sync-nikki-to-stadion.js | head -20</verify>
<done>Function buildPerYearAcfFields exists and returns object with _nikki_{year}_total/saldo/status keys; PUT request includes spread operator for perYearFields in ACF object</done>
</task>

<task id="2">
<title>Add verbose logging and export function</title>
<type>code</type>
<file>sync-nikki-to-stadion.js</file>
<action>
**Step 1: Update verbose logging** after successful update (around line 207):

Replace:
```javascript
logger.verbose('  Updated successfully');
```

With:
```javascript
const years = contributions.map(c => c.year).join(', ');
logger.verbose(`  Updated successfully (years: ${years})`);
```

**Step 2: Export the new function** in module.exports (around line 241):

Update from:
```javascript
module.exports = { runNikkiStadionSync, generateContributionHtml, formatEuro };
```

To:
```javascript
module.exports = { runNikkiStadionSync, generateContributionHtml, formatEuro, buildPerYearAcfFields };
```
</action>
<verify>grep "years:" sync-nikki-to-stadion.js && grep "buildPerYearAcfFields" sync-nikki-to-stadion.js | grep "module.exports"</verify>
<done>Verbose log shows years being synced; buildPerYearAcfFields is exported in module.exports</done>
</task>

<task id="3">
<title>Verify sync on server</title>
<type>verification</type>
<action>
SSH to the production server and run a dry-run sync to verify the changes work correctly.

Commands to execute:
```bash
ssh root@46.202.155.16
cd /home/sportlink
git pull
node sync-nikki-to-stadion.js --verbose --dry-run
```

Verify in output:
1. No errors during execution
2. Verbose output shows "years: XXXX, XXXX" for members being updated
3. Dry-run completes without exceptions

Then run actual sync for one member (if test data exists) or full sync:
```bash
node sync-nikki-to-stadion.js --verbose
```

Check Stadion admin to verify a person record shows:
- `_nikki_2025_total` (or current year) has numeric value
- `_nikki_2025_saldo` has numeric value
- `_nikki_2025_status` has text value like "Debet" or "Credit"
</action>
<verify>SSH to server, run sync, check Stadion admin for per-year fields</verify>
<done>Sync completes without errors; at least one person in Stadion shows _nikki_{year}_total, _nikki_{year}_saldo, and _nikki_{year}_status fields with correct values</done>
</task>

## Verification

After all tasks complete, verify:

1. **Code compiles:** `node -c sync-nikki-to-stadion.js` returns no syntax errors
2. **Function exists:** `buildPerYearAcfFields` is defined and exported
3. **Server sync works:** Running sync on server completes without errors
4. **Stadion fields populated:** At least one person in Stadion shows per-year Nikki fields
