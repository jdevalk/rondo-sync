---
phase: 04-email-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/cron-wrapper.sh
  - scripts/install-cron.sh
autonomous: true

must_haves:
  truths:
    - "Cron log output does not contain npm script header line"
    - "Running install-cron twice results in exactly 2 cron entries (not 4)"
  artifacts:
    - path: "scripts/cron-wrapper.sh"
      provides: "Clean sync execution without npm header"
      contains: "node.*sync-all.js"
    - path: "scripts/install-cron.sh"
      provides: "Idempotent cron installation"
      contains: "grep -v"
  key_links:
    - from: "scripts/cron-wrapper.sh"
      to: "sync-all.js"
      via: "direct node invocation"
      pattern: 'node.*sync-all\.js'
    - from: "scripts/install-cron.sh"
      to: "crontab"
      via: "filter then append pattern"
      pattern: "grep -v.*sportlink"
---

<objective>
Clean up cron output and make cron installation idempotent.

Purpose: Current cron logs include npm header noise ("> sportlink-sync@0.1.0 sync-all") and running install-cron multiple times creates duplicate entries.

Output: Modified shell scripts that produce clean output and handle re-installation gracefully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-email-polish/04-RESEARCH.md
@scripts/cron-wrapper.sh
@scripts/install-cron.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace npm run with direct node invocation</name>
  <files>scripts/cron-wrapper.sh</files>
  <action>
In cron-wrapper.sh, change line 38 from:
```bash
npm run sync-all 2>&1 | tee -a "$LOG_FILE"
```
To:
```bash
node "$PROJECT_DIR/sync-all.js" 2>&1 | tee -a "$LOG_FILE"
```

This eliminates the npm lifecycle output header that pollutes the email report. The sync-all.js script is designed to work when called directly (module/CLI hybrid pattern).

Do NOT use `node --run` as that's a newer Node.js feature and this codebase targets Node.js 18+.
  </action>
  <verify>`grep "npm run" scripts/cron-wrapper.sh` returns nothing. `grep "node.*sync-all.js" scripts/cron-wrapper.sh` returns the line.</verify>
  <done>cron-wrapper.sh calls node directly instead of npm run</done>
</task>

<task type="auto">
  <name>Task 2: Make install-cron idempotent</name>
  <files>scripts/install-cron.sh</files>
  <action>
In install-cron.sh, change line 88 from:
```bash
(crontab -l 2>/dev/null || true; echo "$CRON_ENTRIES") | crontab -
```
To:
```bash
(crontab -l 2>/dev/null | grep -v 'sportlink-sync\|cron-wrapper.sh' || true; echo "$CRON_ENTRIES") | crontab -
```

This filters out any existing sportlink-sync related entries before adding the new ones, making the install idempotent.

The pattern `sportlink-sync\|cron-wrapper.sh` catches:
- Comment lines containing "sportlink-sync"
- Cron job lines containing "cron-wrapper.sh"

The `|| true` ensures the command succeeds even if grep finds nothing (empty crontab or no matching lines).

Also update the comment on line 76 to reflect this is an overwrite operation:
```bash
# Rondo Sync automation (updated $(date +%Y-%m-%d))
```
(Change "installed" to "updated" since this now handles re-installation)
  </action>
  <verify>`grep "grep -v" scripts/install-cron.sh` shows the filter pattern. The crontab installation line includes the filter.</verify>
  <done>install-cron.sh removes existing sportlink-sync entries before adding new ones</done>
</task>

</tasks>

<verification>
1. `grep "npm run" scripts/cron-wrapper.sh` returns no matches
2. `grep "node.*sync-all.js" scripts/cron-wrapper.sh` returns the execution line
3. `grep "grep -v" scripts/install-cron.sh` shows the filter pattern
4. Syntax check: `bash -n scripts/cron-wrapper.sh` returns no errors
5. Syntax check: `bash -n scripts/install-cron.sh` returns no errors
</verification>

<success_criteria>
1. cron-wrapper.sh uses `node sync-all.js` instead of `npm run sync-all`
2. install-cron.sh filters existing sportlink entries before adding new ones
3. Both scripts pass bash syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/04-email-polish/04-02-SUMMARY.md`
</output>
