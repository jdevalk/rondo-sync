---
phase: 32-pipeline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sync-discipline.js
  - scripts/sync.sh
  - scripts/send-email.js
  - scripts/install-cron.sh
  - sync-all.js
autonomous: true

must_haves:
  truths:
    - "`scripts/sync.sh discipline` runs discipline download + sync pipeline"
    - "Cron job scheduled for Monday 11:30 PM Amsterdam time"
    - "Email report shows DISCIPLINE SYNC SUMMARY with formatted sections"
    - "`sync-all.js` includes discipline sync step"
  artifacts:
    - path: "sync-discipline.js"
      provides: "Pipeline orchestrator for discipline sync"
      exports: ["runDisciplineSync"]
      min_lines: 100
    - path: "scripts/sync.sh"
      provides: "CLI wrapper with discipline support"
      contains: "discipline)"
    - path: "scripts/send-email.js"
      provides: "Email formatter with DISCIPLINE title support"
      contains: "DISCIPLINE"
    - path: "scripts/install-cron.sh"
      provides: "Cron installation with discipline entry"
      contains: "discipline"
  key_links:
    - from: "sync-discipline.js"
      to: "download-discipline-cases.js"
      via: "require and runDownload call"
      pattern: "require.*download-discipline-cases"
    - from: "sync-discipline.js"
      to: "submit-stadion-discipline.js"
      via: "require and runSync call"
      pattern: "require.*submit-stadion-discipline"
    - from: "scripts/sync.sh"
      to: "sync-discipline.js"
      via: "SYNC_SCRIPT assignment"
      pattern: 'discipline.*sync-discipline\.js'
---

<objective>
Integrate discipline case sync into the existing automation infrastructure.

Purpose: Enable automated weekly discipline sync with CLI support, cron scheduling, and email reporting. Complete the v2.2 Discipline Cases milestone by making the sync pipeline production-ready.

Output: Fully integrated discipline sync pipeline accessible via `scripts/sync.sh discipline`, scheduled weekly via cron, with formatted email reports.
</objective>

<execution_context>
@/Users/joostdevalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joostdevalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.2-ROADMAP.md
@.planning/STATE.md

# Prior phase output needed for integration
@.planning/phases/31-sync-discipline-to-stadion/31-01-SUMMARY.md

# Existing pipeline patterns to follow
@sync-teams.js
@sync-functions.js
@scripts/sync.sh
@scripts/send-email.js
@scripts/install-cron.sh
@sync-all.js

# Existing discipline components
@download-discipline-cases.js
@submit-stadion-discipline.js
@lib/discipline-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync-discipline.js pipeline orchestrator</name>
  <files>sync-discipline.js</files>
  <action>
Create sync-discipline.js following the exact pattern from sync-teams.js:

1. **Imports:**
   - `require('varlock/auto-load')` at top
   - `createSyncLogger` from `./lib/logger`
   - `runDownload` from `./download-discipline-cases`
   - `runSync` (aliased as `runDisciplineSync`) from `./submit-stadion-discipline`

2. **formatDuration function:**
   - Copy from sync-teams.js (converts ms to "Xm Ys" format)

3. **printSummary function:**
   - Major divider: `========================================`
   - Title: `DISCIPLINE SYNC SUMMARY` (must match this exact format for email formatter)
   - Show: Completed timestamp, Duration
   - Section `DISCIPLINE DOWNLOAD`:
     - Minor divider `----------------------------------------`
     - `Cases downloaded: {stats.download.caseCount}`
   - Section `STADION SYNC`:
     - Minor divider
     - `Cases synced: {synced}/{total}`
     - Conditional lines for Created, Updated, Skipped, Linked to persons
   - Section `ERRORS (N)` if any errors
   - Final major divider

4. **runDisciplineSync function:**
   - Options: `{ verbose = false, force = false }`
   - Create logger with `prefix: 'discipline'`
   - Initialize stats object with:
     - `completedAt`, `duration`
     - `download: { caseCount: 0, errors: [] }`
     - `sync: { total: 0, synced: 0, created: 0, updated: 0, skipped: 0, linked: 0, skipped_no_person: 0, errors: [] }`
   - Step 1: Download discipline cases (try/catch, push to errors on failure)
   - Step 2: Sync to Stadion (try/catch, map result fields, push to errors on failure)
   - Set completedAt and duration
   - Call printSummary
   - Log log file path
   - Close logger
   - Return `{ success: boolean, stats }`

5. **Module exports:**
   - `module.exports = { runDisciplineSync }`

6. **CLI entry point:**
   - Parse `--verbose` and `--force` flags
   - Call runDisciplineSync
   - Set process.exitCode = 1 if not success

**Important notes:**
- The summary section headers must be ALL CAPS (e.g., `DISCIPLINE DOWNLOAD`) for HTML formatting
- The main title must be `DISCIPLINE SYNC SUMMARY` exactly
- Include `linked` stat for persons linked (from Phase 31 runSync result)
- Include `skipped_no_person` stat (cases skipped because person not in Stadion)
  </action>
  <verify>
Run: `node -c sync-discipline.js` (syntax check)
Run: `node -e "const {runDisciplineSync} = require('./sync-discipline'); console.log(typeof runDisciplineSync)"` should print `function`
  </verify>
  <done>sync-discipline.js exists, exports runDisciplineSync function, follows sync-teams.js pattern with correct summary format</done>
</task>

<task type="auto">
  <name>Task 2: Update sync.sh and send-email.js for discipline support</name>
  <files>scripts/sync.sh, scripts/send-email.js</files>
  <action>
**Update scripts/sync.sh:**

1. Line ~40 (validation case statement):
   - Change from: `people|photos|teams|functions|nikki|freescout|reverse|all)`
   - Change to: `people|photos|teams|functions|nikki|freescout|reverse|discipline|all)`

2. Line ~43 (usage message):
   - Change from: `{people|photos|teams|functions|nikki|freescout|reverse|all}`
   - Change to: `{people|photos|teams|functions|nikki|freescout|reverse|discipline|all}`

3. Line ~80-107 (script mapping case statement):
   - Add new case before `all)`:
   ```bash
       discipline)
           SYNC_SCRIPT="sync-discipline.js"
           ;;
   ```

**Update scripts/send-email.js:**

1. Line ~86 (title regex):
   - Change from: `/^(SPORTLINK|PEOPLE|PHOTO|TEAM) SYNC SUMMARY$/`
   - Change to: `/^(SPORTLINK|PEOPLE|PHOTO|TEAM|DISCIPLINE) SYNC SUMMARY$/`
  </action>
  <verify>
Run: `bash -n scripts/sync.sh` (syntax check)
Run: `grep -q 'discipline)' scripts/sync.sh && echo "validation OK" || echo "MISSING"`
Run: `grep -q 'sync-discipline.js' scripts/sync.sh && echo "script mapping OK" || echo "MISSING"`
Run: `grep -q 'DISCIPLINE' scripts/send-email.js && echo "email title OK" || echo "MISSING"`
  </verify>
  <done>sync.sh accepts discipline argument and maps to sync-discipline.js; send-email.js formats DISCIPLINE SYNC SUMMARY as h1</done>
</task>

<task type="auto">
  <name>Task 3: Update install-cron.sh and sync-all.js</name>
  <files>scripts/install-cron.sh, sync-all.js</files>
  <action>
**Update scripts/install-cron.sh:**

1. Echo statements at start (~lines 10-18):
   - Add: `echo "  - Discipline sync:weekly on Monday at 11:30 PM"`
   - Add between Functions sync and Reverse sync lines

2. CRON_ENTRIES variable (~lines 104-125):
   - Add between Functions sync and Reverse sync entries:
   ```bash
   # Discipline sync: weekly on Monday at 11:30 PM
   30 23 * * 1 $PROJECT_DIR/scripts/sync.sh discipline
   ```

3. Final echo statements (~lines 132-139):
   - Add: `echo "  - Discipline sync: weekly on Monday at 11:30 PM"`
   - Add between Functions sync and Reverse sync lines

4. Helpful commands echo (~line 149):
   - Update manual sync options to include discipline:
   - Change from: `{people|teams|functions|nikki|freescout|reverse|all}`
   - Change to: `{people|teams|functions|nikki|freescout|reverse|discipline|all}`

**Update sync-all.js:**

1. Add import after existing imports (~line 19):
   ```javascript
   const { runDisciplineSync: runDisciplinePipelineSync } = require('./sync-discipline');
   ```
   (Note: Aliased to avoid conflict with existing runDisciplineSync from submit-stadion-discipline)

2. Add stats initialization after freescout (~line 382):
   ```javascript
   discipline: {
     total: 0,
     synced: 0,
     created: 0,
     updated: 0,
     skipped: 0,
     linked: 0,
     skipped_no_person: 0,
     errors: []
   }
   ```

3. Add discipline sync step after FreeScout sync (~line 776, before "Complete timing"):
   ```javascript
   // Step 9: Discipline Sync (NON-CRITICAL, weekly pipeline included for completeness)
   logger.verbose('Syncing discipline cases to Stadion...');
   try {
     const disciplineResult = await runDisciplinePipelineSync({ logger, verbose, force });

     if (disciplineResult.stats) {
       stats.discipline = {
         total: disciplineResult.stats.sync.total,
         synced: disciplineResult.stats.sync.synced,
         created: disciplineResult.stats.sync.created,
         updated: disciplineResult.stats.sync.updated,
         skipped: disciplineResult.stats.sync.skipped,
         linked: disciplineResult.stats.sync.linked || 0,
         skipped_no_person: disciplineResult.stats.sync.skipped_no_person || 0,
         errors: []
       };
     }
   } catch (err) {
     logger.error(`Discipline sync failed: ${err.message}`);
     stats.discipline.errors.push({
       message: `Discipline sync failed: ${err.message}`,
       system: 'discipline'
     });
   }
   ```

4. Add DISCIPLINE SYNC section to printSummary (~after FREESCOUT SYNC section):
   ```javascript
   logger.log('DISCIPLINE SYNC');
   logger.log(minorDivider);
   if (stats.discipline.total > 0) {
     const disciplineSyncText = `${stats.discipline.synced}/${stats.discipline.total}`;
     logger.log(`Cases synced: ${disciplineSyncText}`);
     if (stats.discipline.created > 0) {
       logger.log(`  Created: ${stats.discipline.created}`);
     }
     if (stats.discipline.updated > 0) {
       logger.log(`  Updated: ${stats.discipline.updated}`);
     }
     if (stats.discipline.skipped > 0) {
       logger.log(`  Skipped: ${stats.discipline.skipped} (unchanged)`);
     }
     if (stats.discipline.linked > 0) {
       logger.log(`  Linked to persons: ${stats.discipline.linked}`);
     }
     if (stats.discipline.skipped_no_person > 0) {
       logger.log(`  Skipped (no person): ${stats.discipline.skipped_no_person}`);
     }
   } else {
     logger.log('Cases synced: 0 changes');
   }
   logger.log('');
   ```

5. Add discipline errors to allErrors array (~line 252):
   - Add `...stats.discipline.errors` to the spread array

6. Add discipline errors check to success condition (~line 792):
   - Add `stats.discipline.errors.length === 0` to the && chain
  </action>
  <verify>
Run: `bash -n scripts/install-cron.sh` (syntax check)
Run: `grep -q 'Discipline sync' scripts/install-cron.sh && echo "cron entry OK" || echo "MISSING"`
Run: `grep -q '30 23 \* \* 1' scripts/install-cron.sh && echo "cron time OK" || echo "MISSING"`
Run: `node -c sync-all.js` (syntax check)
Run: `grep -q 'runDisciplinePipelineSync' sync-all.js && echo "import OK" || echo "MISSING"`
Run: `grep -q 'DISCIPLINE SYNC' sync-all.js && echo "summary section OK" || echo "MISSING"`
  </verify>
  <done>install-cron.sh adds Monday 11:30 PM cron job; sync-all.js includes discipline sync step with summary output</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax validation:**
   ```bash
   node -c sync-discipline.js
   node -c sync-all.js
   bash -n scripts/sync.sh
   bash -n scripts/install-cron.sh
   ```

2. **Export verification:**
   ```bash
   node -e "const {runDisciplineSync} = require('./sync-discipline'); console.log('sync-discipline OK')"
   ```

3. **Integration verification:**
   ```bash
   # Check sync.sh validates discipline
   echo "discipline" | grep -qE '^(people|photos|teams|functions|nikki|freescout|reverse|discipline|all)$' && echo "validation pattern OK"

   # Check all key patterns exist
   grep -q 'DISCIPLINE SYNC SUMMARY' sync-discipline.js || echo "MISSING: summary title"
   grep -q 'DISCIPLINE' scripts/send-email.js || echo "MISSING: email title"
   grep -q 'discipline)' scripts/sync.sh || echo "MISSING: sync.sh case"
   grep -q '30 23 \* \* 1' scripts/install-cron.sh || echo "MISSING: cron entry"
   grep -q 'runDisciplinePipelineSync' sync-all.js || echo "MISSING: sync-all import"
   ```

4. **Functional test (dry run, won't hit production):**
   ```bash
   # This will fail without database, but confirms script loads
   node sync-discipline.js --verbose 2>&1 | head -5 || echo "Expected error without database"
   ```
</verification>

<success_criteria>
- [ ] `scripts/sync.sh discipline` is a valid command (not "Usage" error)
- [ ] sync-discipline.js loads without syntax errors
- [ ] send-email.js recognizes DISCIPLINE SYNC SUMMARY title
- [ ] install-cron.sh includes discipline cron entry at 23:30 Monday
- [ ] sync-all.js includes discipline sync step with stats
- [ ] All scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/32-pipeline-integration/32-01-SUMMARY.md`

Update documentation:
- README.md: Add discipline to sync commands section
- CLAUDE.md: Add discipline pipeline to architecture section
</output>
